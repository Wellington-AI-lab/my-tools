/**
 * Tag Taxonomy Configuration
 *
 * 双向一致性策略 - Part 1: 标签分类体系
 * 用于约束 AI 模型输出和下游归一化处理
 */

/**
 * 预定义的有效标签白名单
 * 建议从配置文件或 KV/D1 中读取，便于动态更新
 */
export const VALID_TAGS = new Set([
  // ========================================
  // 地理 (Geography)
  // ========================================
  "中国", "CN", "China",
  "美国", "US", "USA", "America",
  "欧洲", "EU",
  "日本", "JP", "Japan",
  "韩国", "KR", "Korea",
  "俄罗斯", "RU", "Russia",
  "印度", "IN", "India",
  "东南亚",
  "中东",
  "英国", "UK", "England",
  "法国",
  "德国",
  "加拿大",
  "澳大利亚",
  "巴西",
  "意大利",
  "西班牙",
  "荷兰",
  "瑞士",
  "瑞典",
  "挪威",
  "丹麦",
  "芬兰",
  "波兰",
  "土耳其",
  "以色列",
  "巴基斯坦",
  "孟加拉",
  "越南",
  "泰国",
  "印尼",
  "马来西亚",
  "新加坡",
  "菲律宾",
  "柬埔寨",
  "缅甸",
  "朝鲜",
  "乌克兰",
  "白俄罗斯",
  "哈萨克斯坦",
  "埃及",
  "南非",
  "阿根廷",
  "墨西哥",
  "台湾",
  "香港",
  "澳门",
  "泰国",
  "巴基斯坦",
  "缅甸",
  "朝鲜",
  "乌克兰",
  "白俄罗斯",
  "哈萨克斯坦",
  "埃及",
  "南非",
  "阿根廷",
  "墨西哥",
  "加拿大",
  "澳大利亚",
  "巴西",
  "意大利",
  "西班牙",
  "荷兰",
  "瑞士",
  "瑞典",
  "挪威",
  "丹麦",
  "芬兰",
  "波兰",
  "土耳其",
  "以色列",
  "希腊",
  "新加坡",
  "马来西亚",
  "印尼",
  "菲律宾",
  "沙特",

  // ========================================
  // 科技 (Technology)
  // ========================================
  "人工智能", "AI", "LLM", "GPT", "机器学习", "深度学习", "大模型",
  "芯片", "半导体", "CPU", "GPU",
  "5G", "6G",
  "新能源车", "电动汽车", "EV", "智能汽车",
  "航天", "卫星", "火箭", "太空",
  "生物技术", "基因",
  "量子计算", "量子",
  "区块链", "加密货币", "比特币", "Crypto", "Web3",
  "元宇宙", "Metaverse",
  "云计算", "Cloud",
  "大数据",
  "物联网", "IoT",
  "网络安全", "安全",
  "自动驾驶",
  "机器人",
  "虚拟现实", "VR", "AR",
  "3D打印",
  "无人机",
  "5nm", "3nm", "制程",
  "操作系统", "OS", "Windows", "Android", "iOS",
  "浏览器", "Chrome", "Edge",
  "搜索引擎", "Google", "百度",
  "社交网络", "社交",
  "短视频", "直播",
  "电商平台", "电商",
  "移动支付", "支付",
  "SaaS",
  "开源",

  // ========================================
  // 经济 (Economy)
  // ========================================
  "经济",
  "通胀", "通货膨胀", "CPI",
  "就业", "失业", "裁员",
  "股市", "股票", "A股", "港股", "美股", "Stock",
  "房地产", "楼市", "住房",
  "消费",
  "贸易",
  "汇率", "外汇",
  "降息", "加息", "利率",
  "GDP", "经济数据",
  "衰退", "经济衰退",
  "复苏",
  "财政",
  "货币",
  "银行", "银行业",
  "保险",
  "金融", "Finance",
  "投资",
  "理财",
  "基金", "ETF",
  "债券",
  "期货", "衍生品",
  "人民币", "美元", "欧元", "日元", "英镑",
  "央行",
  "美联储",
  "负资产",
  "破产",
  "债务",

  // ========================================
  // 社会 (Society)
  // ========================================
  "教育",
  "医疗", "健康",
  "环保", "环境",
  "气候", "气候变化", "全球变暖",
  "人口老龄化", "老龄化", "人口",
  "社保", "社保",
  "就业率",
  "房价",
  "食品安全",
  "公共卫生",
  "疫情", "新冠", "病毒",
  "交通", "出行",
  "物流", "快递",
  "外卖",
  "网约车",
  "共享经济",
  "女性权益",
  "儿童",
  "养老",
  "慈善",
  "公益",
  "志愿服务",
  "社会治理",

  // ========================================
  // 文娱 (Entertainment)
  // ========================================
  "体育", "运动",
  "世界杯", "奥运会", "亚运会",
  "NBA", "CBA",
  "足球", "篮球",
  "电影", "Film", "电影票",
  "电视剧", "剧集",
  "综艺",
  "动漫", "动画",
  "游戏", "电竞", "Gaming", "Esports", "Steam",
  "音乐", "演唱会", "专辑",
  "旅游", "Travel",
  "明星", "娱乐圈", "艺人",
  "网红", "直播",
  "B站", "抖音", "快手", "小红书",
  "热搜",

  // ========================================
  // 时政 (Politics)
  // ========================================
  "政治", "Politics",
  "外交",
  "选举", "大选",
  "政策",
  "国际关系", "地缘政治",
  "制裁",
  "贸易战",
  "两岸关系", "台湾",
  "香港",
  "澳门",
  "两会", "人大", "政协",
  "政府",
  "法律", "立法",
  "司法",
  "公安", "警察",
  "反腐",
  "国家安全",
  "示威", "抗议",

  // ========================================
  // 军事 (Military)
  // ========================================
  "军事", "Military",
  "国防",
  "武器", "军备",
  "军演", "演习",
  "冲突",
  "战争", "War",
  "核武器", "核",
  "导弹",
  "军队", "部队",
  "北约", "NATO",
  "维和",

  // ========================================
  // 能源 (Energy)
  // ========================================
  "能源", "Energy",
  "石油", "原油", "Oil",
  "天然气", "Gas",
  "煤炭",
  "核能", "核电",
  "可再生能源", "新能源",
  "光伏", "太阳能",
  "风电", "风能",
  "水电",
  "储能",
  "电池", "Battery", "锂电池",
  "充电桩",
  "电网",
  "碳中和", "碳达峰",
  "减排",

  // ========================================
  // 企业 (Companies)
  // ========================================
  "华为", "Huawei",
  "小米",
  "比亚迪",
  "特斯拉", "Tesla",
  "苹果", "Apple", "iPhone",
  "英伟达", "Nvidia",
  "微软", "Microsoft",
  "谷歌", "Google",
  "Meta", "Facebook", "Instagram",
  "亚马逊", "Amazon",
  "腾讯", "Tencent", "微信", "QQ",
  "阿里巴巴", "Alibaba", "淘宝", "支付宝",
  "字节跳动", "ByteDance", "抖音", "TikTok",
  "OpenAI", "ChatGPT",
  "台积电", "TSMC",
  "三星", "Samsung",
  "Intel",
  "AMD",
  "高通",
  "索尼", "Sony",
  "任天堂", "Nintendo",
  "迪士尼", "Disney",
  "Netflix",
  "Twitter", "X",
  "SpaceX",
  "波音",
  "空客",
  "丰田",
  "本田",
  "日产",
  "大众",
  "奔驰",
  "宝马",
  "理想",
  "蔚来", "NIO",
  "小鹏",
  "中国移动",
  "中国联通",
  "中国电信",
  "中石油",
  "中石化",
  "工商银行", "ICBC",
  "建设银行",
  "农业银行",
  "中国银行",
  "茅台",
  "拼多多", "PDD",
  "京东",
  "美团",
  "滴滴",
  "快手",
  "B站", "Bilibili",
  "知乎",
  "微博", "Weibo",
  "百度",
  "网易",
  "爱奇艺",
  "腾讯视频",
  "优酷",
  "大疆",
  "闻泰",
  "荣耀",
  "OPPO",
  "vivo",
  "一加",
  "realme",
  "iQOO",
  "红米",
  "Lucid",
  "Rivian",
  "Ford",
  "GM",
  "Hyundai",
  "Kia",
  "Geely",
  "Chery",
  "GreatWall",
  "LG",
  "SK",
  "Hynix",
  "Micron",
  "ASML",
  "Oracle",
  "SAP",
  "Salesforce",
  "Adobe",
  "Autodesk",
  "ServiceNow",

  // ========================================
  // 人物 (People)
  // ========================================
  "特朗普",
  "拜登",
  "马斯克",
  "黄仁勋",
  "库克",
  "扎克伯格",
  "贝佐斯",
  "纳德拉",
  "马云",
  "马化腾",
  "王兴",
  "张一鸣",
  "雷军",
  "李想",
  "李斌",
  "何小鹏",
  "王传福",
  "任正非",
  "余承东",
  "赖清德",

  // ========================================
  // 事件/话题 (Events/Topics)
  // ========================================
  "停火",
  "和平谈判",
  "制裁",
  "贸易战",
  "关税",
  "收购",
  "并购",
  "IPO",
  "上市",
  "破产",
  "违约",
  "降级",
  "加息",
  "降息",
  "量化宽松",
  "缩表",
  "重组",
  "裁员",
  "降薪",
  "涨薪",
  "罢工",
  "示威",
  "抗议",
  "暴乱",
  "恐袭",
  "地震",
  "台风",
  "洪水",
  "干旱",
  "火灾",
  "事故",
  "疫情",
  "封控",
  "解封",
  "检测",
  "疫苗",
  "接种",
  "群体免疫",
  "新馆",
  "奥密克戎",
  "德尔塔",
  "变种",

  // ========================================
  // 行业 (Industries)
  // ========================================
  "互联网", "Internet",
  "电商",
  "零售",
  "快消",
  "餐饮",
  "汽车",
  "房地产",
  "建筑",
  "制造", "制造业",
  "金融", "银行业", "保险业",
  "医疗", "医药", "制药",
  "教育", "培训",
  "传媒", "媒体",
  "广告",
  "物流",
  "交通运输",
  "航空", "机场",
  "酒店", "旅游",
  "游戏",
  "体育",
  "娱乐",
  "文化",
  "出版",
  "印刷",
  "钢铁",
  "化工",
  "有色金属",
  "煤炭",
  "电力",
  "水利",
  "环保",
  "新能源",
  "半导体",
  "通信",
  "软件",
  "硬件",
  "集成电路",

  // ========================================
  // 金融术语 (Finance Terms)
  // ========================================
  "IPO", "上市",
  "并购", "M&A",
  "融资", "创投", "VC", "PE",
  "估值",
  "市值",
  "股价",
  "分红",
  "回购",
  "退市",
  "借壳",
  "涨停",
  "跌停",
  "牛市",
  "熊市",
  "反弹",
  "回调",
  "震荡",

  // ========================================
  // 科技热点 (Tech Trends)
  // ========================================
  "ChatGPT",
  "Sora",
  "Midjourney",
  "元宇宙",
  "Web3",
  "NFT",
  "DAO",
  "DeFi",
  "低代码",
  "无代码",
  "RPA",
  "边缘计算",
  "数字孪生",
  "脑机接口",

  // ========================================
  // 常见事件/话题 (Common Topics)
  // ========================================
  "双十一",
  "618",
  "春节",
  "国庆",
  "高考",
  "考研",
  "毕业季",
  "招聘季",
  "金三银四",
  "金九银十",
  "奥斯卡",
  "格莱美",
  "世界杯",
  "奥运会",
  "亚运会",
  "NBA",
  "CBA",
  "欧冠",
  "英超",
  "西甲",
  "德甲",
  "意甲",
  "法甲",
  "F1",
  "环法",
  "网球",
  "高尔夫",
  "斯诺克",
  "拳击",
  "MMA",
  "UFC",
  "WWE",
  "摔跤",
]);

/**
 * 标签别名映射表
 * 处理常见缩写、异体字、以及模型可能产生的变体
 * 注意：由于 VALID_TAGS 已经包含了大部分常见别名，此表只保留必要的映射
 */
export const TAG_ALIAS_MAP: Record<string, string> = {
  // ========================================
  // 地理别名 (单字/缩写 -> 完整)
  // ========================================
  "中": "中国",
  "cn": "中国",
  "china": "中国",
  "zh": "中国",
  "mainland": "中国",
  "内地": "中国",

  "美": "美国",
  "us": "美国",
  "usa": "美国",
  "united states": "美国",
  "america": "美国",

  "日": "日本",
  "jp": "日本",
  "japan": "日本",

  "韩": "韩国",
  "kr": "韩国",
  "korea": "韩国",
  "south korea": "韩国",

  "俄": "俄罗斯",
  "ru": "俄罗斯",
  "russia": "俄罗斯",

  "泰": "泰国",
  "thai": "泰国",

  "柬": "柬埔寨",

  "越": "越南",
  "vietnam": "越南",

  "乌": "乌克兰",
  "ukraine": "乌克兰",

  "以": "以色列",
  "israel": "以色列",

  "沙": "沙特",

  "印": "印度",
  "in": "印度",
  "india": "印度",

  "巴": "巴基斯坦",

  "菲": "菲律宾",

  "缅": "缅甸",

  "土": "土耳其",

  "希": "希腊",

  "新": "新加坡",
  "singapore": "新加坡",

  "马": "马来西亚",

  "墨": "墨西哥",

  "加": "加拿大",

  "澳": "澳大利亚",

  "阿": "阿根廷",

  "uk": "英国",
  "united kingdom": "英国",
  "england": "英国",

  "eu": "欧洲",
  "europe": "欧洲",
  "欧盟": "欧洲",

  // ========================================
  // 科技别名
  // ========================================
  "ai": "人工智能",
  "llm": "人工智能",
  "gpt": "人工智能",
  "chatgpt": "人工智能",
  "机器学习": "人工智能",
  "深度学习": "人工智能",
  "大模型": "人工智能",

  "semiconductor": "芯片",
  "cpu": "芯片",
  "gpu": "芯片",
  "集成电路": "芯片",

  "ev": "新能源车",
  "电动车": "新能源车",
  "智能汽车": "新能源车",
  "tesla": "新能源车",

  "space": "航天",
  "太空": "航天",

  "metaverse": "元宇宙",
  "web3": "区块链",
  "加密货币": "区块链",
  "crypto": "区块链",
  "比特币": "区块链",

  // ========================================
  // 经济别名
  // ========================================
  "inflation": "通胀",
  "cpi": "通胀",

  "stock": "股市",
  "stocks": "股市",
  "美股": "股市",
  "港股": "股市",
  "a股": "股市",

  "realestate": "房地产",
  "housing": "房地产",
  "楼市": "房地产",

  "retail": "消费",
  "消费者": "消费",
  "零售": "消费",

  "fx": "汇率",
  "foreign exchange": "汇率",

  "rate cut": "降息",
  "rate hike": "加息",

  // ========================================
  // 社会别名
  // ========================================
  "environment": "环保",
  "environmental": "环保",
  "生态": "环保",

  "climate change": "气候变化",
  "global warming": "气候变化",
  "暖化": "气候变化",

  "aging": "人口老龄化",
  "老龄化": "人口老龄化",

  "education": "教育",
  "school": "教育",

  "healthcare": "医疗",
  "health": "医疗",

  // ========================================
  // 文娱别名
  // ========================================
  "esports": "游戏",
  "gaming": "游戏",
  "电子竞技": "游戏",

  "entertainment": "娱乐圈",
  "showbiz": "娱乐圈",

  "music": "音乐",

  // ========================================
  // 时政别名
  // ========================================
  "politics": "政治",
  "election": "选举",
  "policy": "政策",
  "diplomacy": "外交",
  "sanctions": "制裁",
  "trade war": "贸易战",

  // ========================================
  // 军事别名
  // ========================================
  "military": "军事",
  "defense": "防务",
  "weapon": "武器",
  "weapons": "武器",
  "conflict": "冲突",
  "war": "战争",

  // ========================================
  // 能源别名
  // ========================================
  "oil": "石油",
  "gas": "天然气",
  "nuclear": "核能",
  "renewable": "可再生能源",
  "solar": "光伏",
  "太阳能": "光伏",
  "wind": "风电",
  "风能": "风电",
  "storage": "储能",
  "battery": "电池",
  "batteries": "电池",

  // ========================================
  // 企业别名
  // ========================================
  "nvidia": "英伟达",
  "microsoft": "微软",
  "google": "谷歌",
  "amazon": "亚马逊",
  "tiktok": "字节跳动",
  "tsmc": "台积电",
  "taiwan semiconductor": "台积电",
};

/**
 * 生成严格的 System Prompt
 * 用于约束 AI 模型只输出预定义标签
 */
export function generateStrictSystemPrompt(): string {
  // 按类别组织标签，便于 AI 理解
  const categorizedTags: Record<string, string[]> = {
    地理: [],
    科技: [],
    经济: [],
    社会: [],
    文娱: [],
    时政: [],
    军事: [],
    能源: [],
    企业: [],
    行业: [],
  };

  for (const tag of Array.from(VALID_TAGS)) {
    // 简单分类逻辑
    if (["中国", "美国", "欧洲", "日本", "韩国", "俄罗斯", "印度", "东南亚", "中东", "英国", "法国", "德国"].includes(tag)) {
      categorizedTags.地理.push(tag);
    } else if (["人工智能", "芯片", "半导体", "5G", "6G", "新能源车", "电动汽车", "航天", "卫星", "火箭", "生物技术", "量子计算", "区块链", "元宇宙", "云计算", "大数据"].includes(tag)) {
      categorizedTags.科技.push(tag);
    } else if (["经济", "通胀", "通货膨胀", "就业", "股市", "房地产", "消费", "贸易", "汇率", "降息", "加息", "GDP", "衰退", "复苏"].includes(tag)) {
      categorizedTags.经济.push(tag);
    } else if (["教育", "医疗", "环保", "气候", "气候变化", "人口老龄化", "社保", "就业率", "房价", "食品安全", "公共卫生"].includes(tag)) {
      categorizedTags.社会.push(tag);
    } else if (["体育", "电影", "游戏", "电竞", "音乐", "旅游", "综艺", "明星", "娱乐圈"].includes(tag)) {
      categorizedTags.文娱.push(tag);
    } else if (["政治", "外交", "选举", "政策", "国际关系", "制裁", "贸易战", "地缘政治", "两岸关系"].includes(tag)) {
      categorizedTags.时政.push(tag);
    } else if (["军事", "国防", "武器", "军演", "冲突", "战争", "安全", "防务"].includes(tag)) {
      categorizedTags.军事.push(tag);
    } else if (["能源", "石油", "天然气", "核能", "可再生能源", "光伏", "风电", "储能", "电池", "锂电池"].includes(tag)) {
      categorizedTags.能源.push(tag);
    } else if (["华为", "小米", "比亚迪", "特斯拉", "苹果", "英伟达", "微软", "谷歌", "Meta", "亚马逊", "腾讯", "阿里巴巴", "字节跳动", "OpenAI", "台积电", "三星"].includes(tag)) {
      categorizedTags.企业.push(tag);
    } else {
      categorizedTags.行业.push(tag);
    }
  }

  let prompt = `# Taxonomy-Driven Tagging System

You are a content classification engine. Your output MUST strictly adhere to the predefined taxonomy below.

## VALID TAGS (Exhaustive List)

`;

  for (const [category, tags] of Object.entries(categorizedTags)) {
    const tagsArray = Array.from(tags);
    if (tagsArray.length > 0) {
      prompt += `### ${category}\n${tagsArray.join("、")}\n\n`;
    }
  }

  prompt += `## STRICT OUTPUT RULES
1. You MUST ONLY output tags from the above list. This list is exhaustive.
2. If a concept is relevant but NOT in the list:
   - Map it to the CLOSEST standard tag (e.g., "CN" → "中国", "LLM" → "人工智能")
   - If no close match exists, DO NOT invent a new tag. Skip it entirely.
3. Output format: JSON array of strings, e.g., ["中国", "人工智能", "经济"]
4. DO NOT:
   - Create variations or synonyms
   - Use abbreviations unless explicitly listed
   - Add country codes (CN, US, etc.)
   - Translate tags to other languages

## EXAMPLES
Input: "关于中国 AI 发展的新闻"
Output: ["中国", "人工智能"]

Input: "美股通胀数据"
Output: ["美国", "经济", "通胀"]

Input: "韩国 K-Pop 文化输出"
Output: ["韩国", "音乐"]`;

  return prompt;
}

/**
 * 获取扁平化的标签列表
 */
export function getFlatTagList(): string[] {
  return Array.from(VALID_TAGS);
}

/**
 * 检查标签是否有效
 */
export function isValidTag(tag: string): boolean {
  return VALID_TAGS.has(tag);
}

/**
 * 归一化单个标签
 * 应用别名映射并验证是否在白名单中
 */
export function normalizeSingleTag(tag: string): string | null {
  const trimmed = tag.trim();
  if (!trimmed) return null;

  const lowerKey = trimmed.toLowerCase();
  let normalized = TAG_ALIAS_MAP[lowerKey] ?? trimmed;

  if (VALID_TAGS.has(normalized)) {
    return normalized;
  }

  return null; // 不在白名单中
}
