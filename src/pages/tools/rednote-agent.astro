---
import AppLayout from '@/layouts/AppLayout.astro';
---

<AppLayout title="ä¿¡æ¯æµ">
  <div class="space-y-4">
    <div class="glass-effect rounded-xl p-6">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h1 class="text-2xl font-bold text-onekey-text-primary">ä¿¡æ¯æµ</h1>
          <p class="mt-2 text-sm text-onekey-text-secondary">
            åŸºäº Trend Radar æå–çš„å…³é”®è¯ï¼Œæ¯æ—¥è‡ªåŠ¨èšåˆè´¢ç»ã€ç»æµã€AI é¢†åŸŸçš„çƒ­ç‚¹æ–°é—»ã€‚
          </p>
        </div>
        <div class="flex items-center gap-2">
          <button id="news_run" class="text-sm px-3 py-2 rounded-lg border border-black/10 bg-white hover:border-onekey-accent-green/30" type="button">
            æ‰‹åŠ¨è¿è¡Œ
          </button>
        </div>
      </div>
      <div id="news_meta" class="mt-3 text-xs text-onekey-text-muted font-mono"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
      <div class="lg:col-span-1 space-y-4">
        <div class="glass-effect rounded-xl p-6">
          <h2 class="text-lg font-bold text-onekey-text-primary">æ•°æ®æºçŠ¶æ€</h2>
          <div id="news_sources" class="mt-3 text-sm text-onekey-text-secondary">åŠ è½½ä¸­...</div>
        </div>

        <div class="glass-effect rounded-xl p-6">
          <h2 class="text-lg font-bold text-onekey-text-primary">å½“å‰å…³é”®è¯</h2>
          <div id="news_keywords" class="mt-3 text-sm text-onekey-text-secondary">åŠ è½½ä¸­...</div>
        </div>
      </div>

      <div class="lg:col-span-3 space-y-4">
        <div id="news_themes" class="space-y-4">
          <div class="glass-effect rounded-xl p-6 text-center text-onekey-text-secondary">
            åŠ è½½ä¸­...
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    type NewsTheme = 'finance' | 'economy' | 'ai';
    type MatchedNewsItem = {
      id: string;
      source: string;
      title: string;
      summary?: string;
      url: string;
      publishedAt?: string;
      author?: string;
      matchedKeywords: string[];
      relevanceScore: number;
    };
    type NewsReport = {
      meta: {
        generated_at: string;
        day_key: string;
        keywords_used: Record<NewsTheme, string[]>;
        sources_status: Record<string, { ok: boolean; items: number; error?: string }>;
        total_fetched: number;
        total_matched: number;
        execution_time_ms: number;
      };
      by_theme: Array<{
        theme: NewsTheme;
        themeName: string;
        keywords: string[];
        items: MatchedNewsItem[];
      }>;
      empty?: boolean;
    };

    const metaEl = document.getElementById('news_meta');
    const sourcesEl = document.getElementById('news_sources');
    const keywordsEl = document.getElementById('news_keywords');
    const themesEl = document.getElementById('news_themes');
    const runBtn = document.getElementById('news_run');

    const SOURCE_NAMES: Record<string, string> = {
      wallstreetcn: 'åå°”è¡—è§é—»',
      jin10: 'é‡‘åæ•°æ®',
      xueqiu: 'é›ªçƒ',
      thepaper: 'æ¾æ¹ƒæ–°é—»',
      ftchinese: 'FT ä¸­æ–‡ç½‘',
      '36kr': '36æ°ª',
      hackernews: 'Hacker News',
      sspai: 'å°‘æ•°æ´¾',
    };

    const THEME_ICONS: Record<NewsTheme, string> = {
      finance: 'ğŸ’¹',
      economy: 'ğŸ“Š',
      ai: 'ğŸ¤–',
    };

    function escapeHtml(s: string) {
      return String(s || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function timeAgo(dateStr: string | undefined): string {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now.getTime() - date.getTime();
      const diffMins = Math.floor(diffMs / 60000);
      if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
      const diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
      const diffDays = Math.floor(diffHours / 24);
      return `${diffDays}å¤©å‰`;
    }

    function renderMeta(meta: NewsReport['meta']) {
      if (!metaEl) return;
      metaEl.textContent = [
        `æ—¥æœŸ=${meta.day_key}`,
        `è€—æ—¶=${meta.execution_time_ms}ms`,
        `æŠ“å–=${meta.total_fetched}`,
        `åŒ¹é…=${meta.total_matched}`,
      ].join(' Â· ');
    }

    function renderSources(status: Record<string, { ok: boolean; items: number; error?: string }>) {
      if (!sourcesEl) return;
      const entries = Object.entries(status);
      if (entries.length === 0) {
        sourcesEl.textContent = 'æš‚æ— æ•°æ®';
        return;
      }

      const html = entries.map(([id, s]) => {
        const name = SOURCE_NAMES[id] || id;
        const badge = s.ok
          ? '<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700">OK</span>'
          : '<span class="text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700">FAIL</span>';
        const error = s.error ? `<div class="text-xs text-red-500 mt-1">${escapeHtml(s.error)}</div>` : '';
        return `
          <div class="flex items-center justify-between py-2 border-b border-black/5 last:border-0">
            <div>
              <div class="font-medium">${escapeHtml(name)}</div>
              <div class="text-xs text-onekey-text-muted">${s.items} æ¡</div>
              ${error}
            </div>
            ${badge}
          </div>
        `;
      }).join('');

      sourcesEl.innerHTML = `<div class="bg-white/60 rounded-lg border border-black/10 px-3 py-2">${html}</div>`;
    }

    function renderKeywords(keywords: Record<NewsTheme, string[]>) {
      if (!keywordsEl) return;
      const themes: NewsTheme[] = ['finance', 'economy', 'ai'];
      const themeNames: Record<NewsTheme, string> = { finance: 'é‡‘è', economy: 'ç»æµ', ai: 'AI' };

      const html = themes.map((theme) => {
        const kws = keywords[theme] || [];
        const tags = kws.slice(0, 6).map((k) => `<span class="text-xs px-2 py-0.5 rounded-full border border-black/10 bg-white/60">#${escapeHtml(k)}</span>`).join(' ');
        return `
          <div class="py-2 border-b border-black/5 last:border-0">
            <div class="font-medium text-sm">${THEME_ICONS[theme]} ${themeNames[theme]}</div>
            <div class="mt-2 flex flex-wrap gap-1">${tags || '<span class="text-xs text-onekey-text-muted">æš‚æ— </span>'}</div>
          </div>
        `;
      }).join('');

      keywordsEl.innerHTML = `<div class="bg-white/60 rounded-lg border border-black/10 px-3 py-2">${html}</div>`;
    }

    function renderThemes(byTheme: NewsReport['by_theme']) {
      if (!themesEl) return;

      if (!byTheme || byTheme.length === 0) {
        themesEl.innerHTML = `
          <div class="glass-effect rounded-xl p-6 text-center text-onekey-text-secondary">
            æš‚æ— åŒ¹é…çš„æ–°é—»ã€‚è¯·å…ˆè¿è¡Œ Trend Radar ç”Ÿæˆå…³é”®è¯ï¼Œç„¶åè¿è¡Œä¿¡æ¯æµæŠ“å–ã€‚
          </div>
        `;
        return;
      }

      themesEl.innerHTML = byTheme.map((group) => {
        const icon = THEME_ICONS[group.theme] || 'ğŸ“°';
        const cards = group.items.slice(0, 15).map((item) => {
          const sourceName = SOURCE_NAMES[item.source] || item.source;
          const time = timeAgo(item.publishedAt);
          const keywords = item.matchedKeywords.slice(0, 3).map((k) => `<span class="text-xs px-1.5 py-0.5 rounded bg-onekey-accent-green/10 text-onekey-accent-green">#${escapeHtml(k)}</span>`).join(' ');

          return `
            <div class="bg-white rounded-xl p-4 border border-black/5 shadow-sm hover:border-onekey-accent-green/30 transition-colors">
              <div class="flex items-start justify-between gap-3">
                <a href="${escapeHtml(item.url)}" target="_blank" rel="noreferrer" class="font-semibold text-onekey-text-primary hover:underline line-clamp-2">
                  ${escapeHtml(item.title)}
                </a>
              </div>
              ${item.summary ? `<p class="mt-2 text-sm text-onekey-text-secondary line-clamp-2">${escapeHtml(item.summary)}</p>` : ''}
              <div class="mt-3 flex items-center justify-between gap-2 flex-wrap">
                <div class="flex items-center gap-2">
                  <span class="text-xs text-onekey-text-muted">${escapeHtml(sourceName)}</span>
                  ${time ? `<span class="text-xs text-onekey-text-muted">Â· ${time}</span>` : ''}
                </div>
                <div class="flex items-center gap-1">${keywords}</div>
              </div>
            </div>
          `;
        }).join('');

        return `
          <div class="glass-effect rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold text-onekey-text-primary">${icon} ${escapeHtml(group.themeName)}</h2>
              <span class="text-xs text-onekey-text-muted">${group.items.length} æ¡</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
              ${cards || '<div class="text-sm text-onekey-text-secondary">æš‚æ— åŒ¹é…çš„æ–°é—»</div>'}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderReport(report: NewsReport) {
      if (report.empty) {
        if (themesEl) {
          themesEl.innerHTML = `
            <div class="glass-effect rounded-xl p-6 text-center text-onekey-text-secondary">
              ${report.error || 'æš‚æ— æ•°æ®ï¼Œè¯·å…ˆæ‰‹åŠ¨è¿è¡Œä¸€æ¬¡ä¿¡æ¯æµæŠ“å–ã€‚'}
            </div>
          `;
        }
        return;
      }

      renderMeta(report.meta);
      renderSources(report.meta.sources_status);
      renderKeywords(report.meta.keywords_used);
      renderThemes(report.by_theme);
    }

    async function loadLatest() {
      if (themesEl) themesEl.innerHTML = '<div class="glass-effect rounded-xl p-6 text-center text-onekey-text-secondary">åŠ è½½ä¸­...</div>';

      try {
        const resp = await fetch('/api/news/latest', { credentials: 'include' });
        const data = await resp.json() as NewsReport;
        renderReport(data);
      } catch (e) {
        if (themesEl) {
          themesEl.innerHTML = `<div class="glass-effect rounded-xl p-6 text-center text-red-500">åŠ è½½å¤±è´¥: ${e instanceof Error ? e.message : String(e)}</div>`;
        }
      }
    }

    async function runNow() {
      if (runBtn) {
        runBtn.setAttribute('disabled', 'true');
        (runBtn as HTMLButtonElement).textContent = 'è¿è¡Œä¸­...';
      }

      try {
        const resp = await fetch('/api/news/run', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({}),
          credentials: 'include',
        });
        const data = await resp.json() as NewsReport;
        if (!resp.ok) {
          throw new Error((data as any).error || `HTTP ${resp.status}`);
        }
        renderReport(data);
      } catch (e) {
        if (themesEl) {
          themesEl.innerHTML = `<div class="glass-effect rounded-xl p-6 text-center text-red-500">è¿è¡Œå¤±è´¥: ${e instanceof Error ? e.message : String(e)}</div>`;
        }
      } finally {
        if (runBtn) {
          runBtn.removeAttribute('disabled');
          (runBtn as HTMLButtonElement).textContent = 'æ‰‹åŠ¨è¿è¡Œ';
        }
      }
    }

    if (runBtn) runBtn.addEventListener('click', runNow);
    loadLatest();
  </script>
</AppLayout>
