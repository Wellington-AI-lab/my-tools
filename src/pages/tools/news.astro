---
import AppLayout from '@/layouts/AppLayout.astro';
---

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#f5f5f7">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="VibeNews">

<AppLayout title="新闻聚合">
  <div class="titan-content">
    <!-- 标题卡片 -->
    <div class="titan-card">
      <h1 class="titan-heading titan-heading-2 titan-text-center">新闻聚合</h1>
      <div id="metaInfo" class="titan-meta-info">
        <span class="titan-number" id="totalCount">-</span> 篇文章 · 数据持续更新中
        <span class="titan-divider">·</span>
        <a href="https://news-api.zhusen-wang.workers.dev/rss" target="_blank" rel="noopener" class="titan-rss-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 11a9 9 0 0 1 9 9"></path>
            <path d="M4 4a16 16 0 0 1 16 16"></path>
            <circle cx="5" cy="19" r="1"></circle>
          </svg>
          RSS订阅
        </a>
      </div>
    </div>

    <!-- 统计面板 -->
    <div class="titan-stats-grid" id="statsPanel">
      <div class="titan-loading">加载中...</div>
    </div>

    <!-- 新闻列表 -->
    <div class="titan-card titan-card-list">
      <div id="newsList" class="titan-news-list">
        <div class="titan-loading">加载中...</div>
      </div>
      <!-- 加载更多 -->
      <div id="loadMoreContainer" class="titan-load-more hidden">
        <button id="loadMoreBtn" class="titan-load-more-btn">加载更多</button>
      </div>
    </div>
  </div>

  <style is:global>
    /* Titan News Page Styles */

    .titan-content {
      max-width: 80rem;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .titan-text-center {
      text-align: center;
    }

    .titan-meta-info {
      margin-top: 12px;
      text-align: center;
      font-size: var(--titan-text-sm);
      color: var(--titan-ink-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .titan-divider {
      color: var(--titan-ink-tertiary);
    }

    .titan-rss-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--titan-action-primary);
      text-decoration: none;
      transition: opacity var(--titan-duration-fast);
    }

    .titan-rss-link:hover {
      opacity: 0.7;
      text-decoration: underline;
    }

    /* 统计面板网格 */
    .titan-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .titan-stat-item {
      background: var(--titan-surface-base);
      border: 1px solid var(--titan-border-subtle);
      border-radius: var(--titan-radius-md);
      padding: 16px;
      text-align: center;
      transition: all var(--titan-duration-normal) var(--titan-ease-out);
    }

    .titan-stat-item:hover {
      border-color: var(--titan-border-default);
      transform: translateY(-2px);
    }

    .titan-stat-value {
      font-size: var(--titan-text-2xl);
      font-weight: 700;
      color: var(--titan-ink-primary);
      font-family: "Georgia", 'Times New Roman', serif;
      margin-bottom: 4px;
    }

    .titan-stat-label {
      font-size: var(--titan-text-xs);
      color: var(--titan-ink-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* 新闻列表 */
    .titan-card-list {
      overflow: hidden;
    }

    .titan-news-list {
      display: flex;
      flex-direction: column;
    }

    .titan-news-item {
      display: block;
      padding: 16px;
      border-bottom: 1px solid var(--titan-border-subtle);
      text-decoration: none;
      transition: all var(--titan-duration-fast) var(--titan-ease-out);
      cursor: pointer;
    }

    .titan-news-item:last-child {
      border-bottom: none;
    }

    .titan-news-item:hover {
      background: var(--titan-surface-subtle);
    }

    .titan-news-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }

    .titan-news-title {
      flex: 1;
      font-size: var(--titan-text-base);
      font-weight: 500;
      color: var(--titan-ink-primary);
      line-height: 1.5;
    }

    .titan-news-source {
      flex-shrink: 0;
      padding: 4px 10px;
      border-radius: var(--titan-radius-xl);
      font-size: var(--titan-text-xs);
      font-weight: 600;
      color: white;
      white-space: nowrap;
    }

    /* 来源颜色 */
    .titan-source-v2ex { background: #e74c3c; }
    .titan-source-hn { background: #ff6600; }
    .titan-source-36kr { background: #00a6e7; }
    .titan-source-tc { background: #00a97e; }
    .titan-source-ssp { background: #7c6cdb; }
    .titan-source-default { background: var(--titan-ink-secondary); }

    .titan-news-summary {
      font-size: var(--titan-text-sm);
      color: var(--titan-ink-secondary);
      line-height: 1.6;
      margin-bottom: 8px;
      white-space: pre-wrap;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .titan-news-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: var(--titan-text-xs);
      color: var(--titan-ink-tertiary);
    }

    .titan-news-time {
      font-family: "Georgia", 'Times New Roman', serif;
    }

    .titan-news-link {
      margin-left: auto;
      color: var(--titan-action-primary);
      font-size: var(--titan-text-sm);
    }

    /* 加载状态 */
    .titan-loading {
      padding: 32px;
      text-align: center;
      color: var(--titan-ink-secondary);
      font-size: var(--titan-text-sm);
    }

    .titan-load-more {
      border-top: 1px solid var(--titan-border-subtle);
    }

    .titan-load-more.hidden {
      display: none;
    }

    .titan-load-more-btn {
      width: 100%;
      padding: 12px;
      font-size: var(--titan-text-sm);
      color: var(--titan-ink-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: background var(--titan-duration-fast);
    }

    .titan-load-more-btn:hover {
      background: var(--titan-surface-subtle);
    }

    /* 响应式 */
    @media (max-width: 640px) {
      .titan-stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>

  <script>
    const API_BASE = 'https://news-api.zhusen-wang.workers.dev';
    const PAGE_SIZE = 20;

    // 状态
    let currentPage = 1;
    let currentSource = 'all';
    let hasMore = true;
    let isLoading = false;
    let allArticles: any[] = [];

    // DOM 元素
    const totalCountEl = document.getElementById('totalCount');
    const statsPanel = document.getElementById('statsPanel');
    const newsList = document.getElementById('newsList');
    const loadMoreContainer = document.getElementById('loadMoreContainer');
    const loadMoreBtn = document.getElementById('loadMoreBtn');

    // 来源颜色映射
    const sourceClassMap: Record<string, string> = {
      'V2EX': 'titan-source-v2ex',
      'Hacker News': 'titan-source-hn',
      '36氪': 'titan-source-36kr',
      'TechCrunch': 'titan-source-tc',
      '少数派': 'titan-source-ssp',
    };

    function getSourceClass(source: string): string {
      return sourceClassMap[source] || 'titan-source-default';
    }

    // HTML 转义
    function escapeHtml(str: string): string {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // 格式化时间
    function formatTime(timestamp: number): string {
      const now = Date.now();
      const diff = now - timestamp * 1000;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return '刚刚';
      if (minutes < 60) return `${minutes}分钟前`;
      if (hours < 24) return `${hours}小时前`;
      if (days < 7) return `${days}天前`;

      const date = new Date(timestamp * 1000);
      return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
    }

    // 加载统计信息
    async function loadStats() {
      try {
        const resp = await fetch(`${API_BASE}/stats`);
        const data = await resp.json();
        if (data.success) {
          renderStats(data);
          if (totalCountEl) {
            totalCountEl.textContent = String(data.totalArticles || 0);
          }
        }
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }

    // 渲染统计信息
    function renderStats(data: any) {
      if (!statsPanel) return;

      const html = (data.bySource || []).map((s: any) => {
        const sourceKey = s.source;
        const colorClass = getSourceClass(sourceKey);
        return `
          <div class="titan-stat-item" data-source="${escapeHtml(sourceKey)}">
            <div class="titan-stat-value">${s.count}</div>
            <div class="titan-stat-label">${escapeHtml(s.source)}</div>
          </div>
        `;
      }).join('');

      statsPanel.innerHTML = html;

      // 统计卡片点击筛选
      statsPanel.querySelectorAll('.titan-stat-item').forEach(item => {
        item.addEventListener('click', () => {
          const source = item.getAttribute('data-source') || 'all';
          selectSource(source);
        });
        item.style.cursor = 'pointer';
      });
    }

    // 加载新闻
    async function loadNews(append = false) {
      if (isLoading) return;

      isLoading = true;
      updateLoadMoreUI();

      try {
        const url = new URL(`${API_BASE}/latest`);
        url.searchParams.set('page', String(currentPage));
        url.searchParams.set('limit', String(PAGE_SIZE));

        const resp = await fetch(url.toString());
        const data = await resp.json();

        if (data.success) {
          if (!append) {
            allArticles = [];
          }
          allArticles.push(...(data.data || []));

          renderNews();
          hasMore = data.hasMore;
          currentPage++;
        }
      } catch (e) {
        console.error('Failed to load news:', e);
        if (!append && newsList) {
          newsList.innerHTML = '<div class="titan-loading">加载失败，请刷新重试</div>';
        }
      } finally {
        isLoading = false;
        updateLoadMoreUI();
      }
    }

    // 渲染新闻列表
    function renderNews() {
      if (!newsList) return;

      let displayArticles = allArticles;

      // 前端筛选
      if (currentSource !== 'all') {
        displayArticles = allArticles.filter(a => a.source === currentSource);
      }

      if (displayArticles.length === 0) {
        newsList.innerHTML = '<div class="titan-loading">暂无数据</div>';
        loadMoreContainer?.classList.add('hidden');
        return;
      }

      const html = displayArticles.map(article => {
        const sourceClass = getSourceClass(article.source);
        const timeStr = formatTime(article.created_at);
        const summary = article.summary ? escapeHtml(article.summary) : '';

        return `
          <a href="${escapeHtml(article.url)}" target="_blank" rel="noopener noreferrer" class="titan-news-item">
            <div class="titan-news-header">
              <h3 class="titan-news-title">${escapeHtml(article.title)}</h3>
              <span class="titan-news-source ${sourceClass}">${escapeHtml(article.source)}</span>
            </div>
            ${summary ? `<p class="titan-news-summary">${summary}</p>` : ''}
            <div class="titan-news-meta">
              <span class="titan-news-time">${timeStr}</span>
              <span class="titan-news-link">→</span>
            </div>
          </a>
        `;
      }).join('');

      newsList.innerHTML = html;
    }

    // 更新加载更多按钮
    function updateLoadMoreUI() {
      if (!loadMoreContainer || !loadMoreBtn) return;

      if (!hasMore) {
        loadMoreContainer.classList.add('hidden');
      } else {
        loadMoreContainer.classList.remove('hidden');
        loadMoreBtn.textContent = isLoading ? '加载中...' : '加载更多';
        loadMoreBtn.disabled = isLoading;
      }
    }

    // 选择来源（用于统计卡片点击筛选）
    function selectSource(source: string) {
      currentSource = source;

      // 重新渲染列表（前端筛选）
      renderNews();

      // 如果是切换到新来源且数据不足，加载更多
      if (source !== 'all') {
        const filtered = allArticles.filter(a => a.source === source);
        if (filtered.length < PAGE_SIZE && hasMore) {
          loadNews(true);
        }
      }

      // 更新加载更多按钮
      updateLoadMoreUI();
    }

    // 加载更多按钮
    loadMoreBtn?.addEventListener('click', () => {
      loadNews(true);
    });

    // 初始化
    loadStats();
    loadNews(false);
  </script>
</AppLayout>
