---
import AppLayout from '@/layouts/AppLayout.astro';
---

<AppLayout title="æ–°é—»èšåˆ">
  <div class="titan-content">
    <!-- æ ‡é¢˜å¡ç‰‡ -->
    <div class="titan-card">
      <h1 class="titan-heading titan-heading-2 titan-text-center">æ–°é—»èšåˆ</h1>
      <div id="metaInfo" class="titan-meta-info">
        <span class="titan-number" id="totalCount">-</span> ç¯‡æ–‡ç«  Â· æ•°æ®æŒç»­æ›´æ–°ä¸­
      </div>
    </div>

    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div class="titan-stats-grid" id="statsPanel">
      <div class="titan-loading">åŠ è½½ä¸­...</div>
    </div>

    <!-- æ¥æºç­›é€‰ Tabs -->
    <div class="titan-tabs-container">
      <div class="titan-tabs" id="filterTabs">
        <button data-source="all" class="titan-tab active">
          <div class="titan-tab-icon">ğŸ“°</div>
          <div class="titan-tab-label">å…¨éƒ¨</div>
        </button>
        <button data-source="V2EX" class="titan-tab">
          <div class="titan-tab-icon">ğŸ’¬</div>
          <div class="titan-tab-label">V2EX</div>
        </button>
        <button data-source="Hacker News" class="titan-tab">
          <div class="titan-tab-icon">ğŸ”¶</div>
          <div class="titan-tab-label">HN</div>
        </button>
        <button data-source="36æ°ª" class="titan-tab">
          <div class="titan-tab-icon">ğŸš€</div>
          <div class="titan-tab-label">36æ°ª</div>
        </button>
        <button data-source="TechCrunch" class="titan-tab">
          <div class="titan-tab-icon">âš¡</div>
          <div class="titan-tab-label">TechCrunch</div>
        </button>
        <button data-source="å°‘æ•°æ´¾" class="titan-tab">
          <div class="titan-tab-icon">ğŸ¯</div>
          <div class="titan-tab-label">å°‘æ•°æ´¾</div>
        </button>
      </div>
    </div>

    <!-- æ–°é—»åˆ—è¡¨ -->
    <div class="titan-card titan-card-list">
      <div id="newsList" class="titan-news-list">
        <div class="titan-loading">åŠ è½½ä¸­...</div>
      </div>
      <!-- åŠ è½½æ›´å¤š -->
      <div id="loadMoreContainer" class="titan-load-more hidden">
        <button id="loadMoreBtn" class="titan-load-more-btn">åŠ è½½æ›´å¤š</button>
      </div>
    </div>
  </div>

  <style is:global>
    /* Titan News Page Styles */

    .titan-content {
      max-width: 80rem;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .titan-text-center {
      text-align: center;
    }

    .titan-meta-info {
      margin-top: 12px;
      text-align: center;
      font-size: var(--titan-text-sm);
      color: var(--titan-ink-secondary);
    }

    /* ç»Ÿè®¡é¢æ¿ç½‘æ ¼ */
    .titan-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .titan-stat-item {
      background: var(--titan-surface-base);
      border: 1px solid var(--titan-border-subtle);
      border-radius: var(--titan-radius-md);
      padding: 16px;
      text-align: center;
      transition: all var(--titan-duration-normal) var(--titan-ease-out);
    }

    .titan-stat-item:hover {
      border-color: var(--titan-border-default);
      transform: translateY(-2px);
    }

    .titan-stat-value {
      font-size: var(--titan-text-2xl);
      font-weight: 700;
      color: var(--titan-ink-primary);
      font-family: "Georgia", 'Times New Roman', serif;
      margin-bottom: 4px;
    }

    .titan-stat-label {
      font-size: var(--titan-text-xs);
      color: var(--titan-ink-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Tabs */
    .titan-tabs-container {
      background: var(--titan-surface-base);
      border: 1px solid var(--titan-border-subtle);
      border-radius: var(--titan-radius-lg);
      padding: 8px;
    }

    .titan-tabs {
      display: flex;
      align-items: stretch;
      gap: 4px;
      overflow-x: auto;
    }

    .titan-tab {
      flex: 1;
      min-width: 80px;
      padding: 12px 16px;
      border-radius: var(--titan-radius-md);
      font-size: var(--titan-text-sm);
      font-weight: 500;
      color: var(--titan-ink-secondary);
      background: transparent;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all var(--titan-duration-fast) var(--titan-ease-out);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .titan-tab:hover {
      color: var(--titan-ink-primary);
      background: var(--titan-surface-subtle);
    }

    .titan-tab.active {
      background: var(--titan-surface-base);
      color: var(--titan-ink-primary);
      box-shadow: var(--titan-shadow-card);
      border-bottom-width: 2px;
      border-bottom-style: solid;
      border-bottom-color: var(--titan-action-primary);
    }

    .titan-tab-icon {
      font-size: var(--titan-text-lg);
    }

    .titan-tab-label {
      font-weight: 600;
      font-size: var(--titan-text-xs);
    }

    /* æ–°é—»åˆ—è¡¨ */
    .titan-card-list {
      overflow: hidden;
    }

    .titan-news-list {
      display: flex;
      flex-direction: column;
    }

    .titan-news-item {
      display: block;
      padding: 16px;
      border-bottom: 1px solid var(--titan-border-subtle);
      text-decoration: none;
      transition: all var(--titan-duration-fast) var(--titan-ease-out);
      cursor: pointer;
    }

    .titan-news-item:last-child {
      border-bottom: none;
    }

    .titan-news-item:hover {
      background: var(--titan-surface-subtle);
    }

    .titan-news-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }

    .titan-news-title {
      flex: 1;
      font-size: var(--titan-text-base);
      font-weight: 500;
      color: var(--titan-ink-primary);
      line-height: 1.5;
    }

    .titan-news-source {
      flex-shrink: 0;
      padding: 4px 10px;
      border-radius: var(--titan-radius-xl);
      font-size: var(--titan-text-xs);
      font-weight: 600;
      color: white;
      white-space: nowrap;
    }

    /* æ¥æºé¢œè‰² */
    .titan-source-v2ex { background: #e74c3c; }
    .titan-source-hn { background: #ff6600; }
    .titan-source-36kr { background: #00a6e7; }
    .titan-source-tc { background: #00a97e; }
    .titan-source-ssp { background: #7c6cdb; }
    .titan-source-default { background: var(--titan-ink-secondary); }

    .titan-news-summary {
      font-size: var(--titan-text-sm);
      color: var(--titan-ink-secondary);
      line-height: 1.6;
      margin-bottom: 8px;
      white-space: pre-wrap;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .titan-news-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: var(--titan-text-xs);
      color: var(--titan-ink-tertiary);
    }

    .titan-news-time {
      font-family: "Georgia", 'Times New Roman', serif;
    }

    .titan-news-link {
      margin-left: auto;
      color: var(--titan-action-primary);
      font-size: var(--titan-text-sm);
    }

    /* åŠ è½½çŠ¶æ€ */
    .titan-loading {
      padding: 32px;
      text-align: center;
      color: var(--titan-ink-secondary);
      font-size: var(--titan-text-sm);
    }

    .titan-load-more {
      border-top: 1px solid var(--titan-border-subtle);
    }

    .titan-load-more.hidden {
      display: none;
    }

    .titan-load-more-btn {
      width: 100%;
      padding: 12px;
      font-size: var(--titan-text-sm);
      color: var(--titan-ink-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: background var(--titan-duration-fast);
    }

    .titan-load-more-btn:hover {
      background: var(--titan-surface-subtle);
    }

    /* å“åº”å¼ */
    @media (max-width: 640px) {
      .titan-tabs {
        justify-content: flex-start;
      }

      .titan-tab {
        min-width: 70px;
        padding: 10px 12px;
      }

      .titan-stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>

  <script>
    const API_BASE = 'https://news-api.zhusen-wang.workers.dev';
    const PAGE_SIZE = 20;

    // çŠ¶æ€
    let currentPage = 1;
    let currentSource = 'all';
    let hasMore = true;
    let isLoading = false;
    let allArticles: any[] = [];

    // DOM å…ƒç´ 
    const totalCountEl = document.getElementById('totalCount');
    const statsPanel = document.getElementById('statsPanel');
    const newsList = document.getElementById('newsList');
    const loadMoreContainer = document.getElementById('loadMoreContainer');
    const loadMoreBtn = document.getElementById('loadMoreBtn');

    // æ¥æºé¢œè‰²æ˜ å°„
    const sourceClassMap: Record<string, string> = {
      'V2EX': 'titan-source-v2ex',
      'Hacker News': 'titan-source-hn',
      '36æ°ª': 'titan-source-36kr',
      'TechCrunch': 'titan-source-tc',
      'å°‘æ•°æ´¾': 'titan-source-ssp',
    };

    function getSourceClass(source: string): string {
      return sourceClassMap[source] || 'titan-source-default';
    }

    // HTML è½¬ä¹‰
    function escapeHtml(str: string): string {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp: number): string {
      const now = Date.now();
      const diff = now - timestamp * 1000;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'åˆšåˆš';
      if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
      if (hours < 24) return `${hours}å°æ—¶å‰`;
      if (days < 7) return `${days}å¤©å‰`;

      const date = new Date(timestamp * 1000);
      return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
    }

    // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
    async function loadStats() {
      try {
        const resp = await fetch(`${API_BASE}/stats`);
        const data = await resp.json();
        if (data.success) {
          renderStats(data);
          if (totalCountEl) {
            totalCountEl.textContent = String(data.totalArticles || 0);
          }
        }
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }

    // æ¸²æŸ“ç»Ÿè®¡ä¿¡æ¯
    function renderStats(data: any) {
      if (!statsPanel) return;

      const html = (data.bySource || []).map((s: any) => {
        const sourceKey = s.source;
        const colorClass = getSourceClass(sourceKey);
        return `
          <div class="titan-stat-item" data-source="${escapeHtml(sourceKey)}">
            <div class="titan-stat-value">${s.count}</div>
            <div class="titan-stat-label">${escapeHtml(s.source)}</div>
          </div>
        `;
      }).join('');

      statsPanel.innerHTML = html;

      // ç»Ÿè®¡å¡ç‰‡ç‚¹å‡»ç­›é€‰
      statsPanel.querySelectorAll('.titan-stat-item').forEach(item => {
        item.addEventListener('click', () => {
          const source = item.getAttribute('data-source') || 'all';
          selectSource(source);
        });
        item.style.cursor = 'pointer';
      });
    }

    // åŠ è½½æ–°é—»
    async function loadNews(append = false) {
      if (isLoading) return;

      isLoading = true;
      updateLoadMoreUI();

      try {
        const url = new URL(`${API_BASE}/latest`);
        url.searchParams.set('page', String(currentPage));
        url.searchParams.set('limit', String(PAGE_SIZE));

        const resp = await fetch(url.toString());
        const data = await resp.json();

        if (data.success) {
          if (!append) {
            allArticles = [];
          }
          allArticles.push(...(data.data || []));

          renderNews();
          hasMore = data.hasMore;
          currentPage++;
        }
      } catch (e) {
        console.error('Failed to load news:', e);
        if (!append && newsList) {
          newsList.innerHTML = '<div class="titan-loading">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
        }
      } finally {
        isLoading = false;
        updateLoadMoreUI();
      }
    }

    // æ¸²æŸ“æ–°é—»åˆ—è¡¨
    function renderNews() {
      if (!newsList) return;

      let displayArticles = allArticles;

      // å‰ç«¯ç­›é€‰
      if (currentSource !== 'all') {
        displayArticles = allArticles.filter(a => a.source === currentSource);
      }

      if (displayArticles.length === 0) {
        newsList.innerHTML = '<div class="titan-loading">æš‚æ— æ•°æ®</div>';
        loadMoreContainer?.classList.add('hidden');
        return;
      }

      const html = displayArticles.map(article => {
        const sourceClass = getSourceClass(article.source);
        const timeStr = formatTime(article.created_at);
        const summary = article.summary ? escapeHtml(article.summary) : '';

        return `
          <a href="${escapeHtml(article.url)}" target="_blank" rel="noopener noreferrer" class="titan-news-item">
            <div class="titan-news-header">
              <h3 class="titan-news-title">${escapeHtml(article.title)}</h3>
              <span class="titan-news-source ${sourceClass}">${escapeHtml(article.source)}</span>
            </div>
            ${summary ? `<p class="titan-news-summary">${summary}</p>` : ''}
            <div class="titan-news-meta">
              <span class="titan-news-time">${timeStr}</span>
              <span class="titan-news-link">â†’</span>
            </div>
          </a>
        `;
      }).join('');

      newsList.innerHTML = html;
    }

    // æ›´æ–°åŠ è½½æ›´å¤šæŒ‰é’®
    function updateLoadMoreUI() {
      if (!loadMoreContainer || !loadMoreBtn) return;

      if (!hasMore) {
        loadMoreContainer.classList.add('hidden');
      } else {
        loadMoreContainer.classList.remove('hidden');
        loadMoreBtn.textContent = isLoading ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š';
        loadMoreBtn.disabled = isLoading;
      }
    }

    // é€‰æ‹©æ¥æº
    function selectSource(source: string) {
      currentSource = source;

      // æ›´æ–° Tab æ ·å¼
      document.querySelectorAll('.titan-tab').forEach(tab => {
        const tabSource = tab.getAttribute('data-source') || 'all';
        tab.classList.toggle('active', tabSource === source);
      });

      // é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆå‰ç«¯ç­›é€‰ï¼‰
      renderNews();

      // å¦‚æœæ˜¯åˆ‡æ¢åˆ°æ–°æ¥æºä¸”æ•°æ®ä¸è¶³ï¼ŒåŠ è½½æ›´å¤š
      if (source !== 'all') {
        const filtered = allArticles.filter(a => a.source === source);
        if (filtered.length < PAGE_SIZE && hasMore) {
          loadNews(true);
        }
      }

      // æ›´æ–°åŠ è½½æ›´å¤šæŒ‰é’®
      updateLoadMoreUI();
    }

    // Tab ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.titan-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const source = tab.getAttribute('data-source') || 'all';
        selectSource(source);
      });
    });

    // åŠ è½½æ›´å¤šæŒ‰é’®
    loadMoreBtn?.addEventListener('click', () => {
      loadNews(true);
    });

    // åˆå§‹åŒ–
    loadStats();
    loadNews(false);
  </script>
</AppLayout>
