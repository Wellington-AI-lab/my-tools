---
import AppLayout from '@/layouts/AppLayout.astro';
---

<AppLayout title="è‚¡ç¥¨ç»„åˆæ¨¡æ‹Ÿæ”¶ç›Šç‡å›æµ‹">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="lg:col-span-2">
      <div class="glass-effect rounded-xl p-6">
        <h1 class="text-2xl font-bold text-onekey-text-primary text-center mb-4">è‚¡ç¥¨ç»„åˆæ¨¡æ‹Ÿæ”¶ç›Šç‡å›æµ‹</h1>

        <div class="mt-5 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-onekey-text-secondary mb-1">å¼€å§‹æ—¥æœŸ</label>
              <input id="startDate" type="date" min="2000-01-01" class="w-full px-4 py-2 bg-white border border-black/10 rounded-lg" />
            </div>
            <div>
              <label class="block text-sm text-onekey-text-secondary mb-1">ç»“æŸæ—¥æœŸ</label>
              <input id="endDate" type="date" min="2000-01-01" class="w-full px-4 py-2 bg-white border border-black/10 rounded-lg" />
            </div>
          </div>

          <div class="border border-black/10 rounded-lg overflow-hidden">
            <div class="bg-white/60 px-4 py-2 flex items-center justify-between">
              <div class="text-sm font-semibold text-onekey-text-primary">èµ„äº§ç»„åˆåŠæƒé‡</div>
              <div class="flex items-center gap-2">
                <button id="addRowBtn" class="text-sm px-3 py-1.5 rounded-full border border-black/10 bg-white hover:border-onekey-accent-green/30" type="button">
                  + æ·»åŠ ä¸€è¡Œ
                </button>
                <button id="saveWatchlistBtn" class="text-sm px-3 py-1.5 rounded-full border border-black/10 bg-white hover:border-onekey-accent-green/30" type="button">
                  å†™å…¥æ ‡çš„æ± 
                </button>
              </div>
            </div>

            <div class="p-4 bg-white">
              <div id="rows" class="space-y-2"></div>
              <div class="mt-3 text-xs text-onekey-text-secondary">
                æç¤ºï¼šæƒé‡ä¼šè‡ªåŠ¨å½’ä¸€åŒ–ï¼ˆä¸è¦æ±‚æ€»å’Œ=100ï¼‰ã€‚å»ºè®®å¸¸ç”¨ â‰¤10 åªã€‚
              </div>
            </div>
          </div>

          <div id="errorBox" class="hidden text-sm text-red-600"></div>
          <button id="calcBtn" class="w-full py-2.5 px-4 bg-gradient-neon text-white font-bold rounded-lg hover:opacity-90 transition-opacity" type="button">
            è®¡ç®—ï¼ˆCAGR / æ€»æ”¶ç›Š / æœ€å¤§å›æ’¤ / å¤æ™®ï¼‰
          </button>
        </div>
      </div>

      <div class="glass-effect rounded-xl p-6 mt-4" id="resultSection">
        <h2 class="text-xl font-bold text-onekey-text-primary text-center mb-4">å›æµ‹ç»“æœ</h2>
        <div id="resultBox">
          <div class="text-sm text-onekey-text-secondary">å°šæœªè®¡ç®—ã€‚ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹å›æµ‹ã€‚</div>
        </div>
      </div>

      <!-- æ”¶ç›Šç‡èµ°åŠ¿å›¾ -->
      <div class="glass-effect rounded-xl p-6 mt-4" id="chartSection" style="display: none;">
        <h2 class="text-xl font-bold text-onekey-text-primary text-center mb-4">å‡€å€¼èµ°åŠ¿å›¾</h2>
        <div class="flex items-center justify-center gap-6 text-xs mb-4">
          <div class="flex items-center gap-1.5">
            <div class="w-3 h-0.5 bg-green-500 rounded"></div>
            <span class="text-onekey-text-secondary">ç»„åˆ</span>
          </div>
          <div class="flex items-center gap-1.5">
            <div class="w-3 h-0.5 bg-blue-400 rounded"></div>
            <span class="text-onekey-text-secondary">QQQ åŸºå‡†</span>
          </div>
          <div class="flex items-center gap-1.5">
            <div class="w-3 h-3 bg-red-100 border border-red-300 rounded-sm"></div>
            <span class="text-onekey-text-secondary">æœ€å¤§å›æ’¤åŒºé—´</span>
          </div>
        </div>
        <div id="chartContainer" style="height: 400px; width: 100%;"></div>
        <div id="chartInfo" class="mt-3 text-xs text-onekey-text-muted text-center"></div>
      </div>
    </div>

    <div class="lg:col-span-1">
      <div class="glass-effect rounded-xl p-6">
        <h2 class="text-lg font-bold text-onekey-text-primary">æ ‡çš„æ± ï¼ˆWatchlistï¼‰</h2>
        <p class="mt-2 text-sm text-onekey-text-secondary">
          ç‚¹å‡»æ ‡çš„å¯å¿«é€ŸåŠ å…¥ç»„åˆï¼›è§„åˆ™æ ‡ç­¾ä¼šè‡ªåŠ¨åˆå¹¶å±•ç¤ºã€‚
        </p>
        <div id="watchlistBox" class="mt-4 space-y-2 text-sm text-onekey-text-secondary">
          åŠ è½½ä¸­...
        </div>
      </div>
    </div>
  </div>

  <script>
    import { createChart, LineSeries, createSeriesMarkers } from 'lightweight-charts';
    
    const rowsEl = document.getElementById('rows') as HTMLElement | null;
    const addRowBtn = document.getElementById('addRowBtn') as HTMLButtonElement | null;
    const calcBtn = document.getElementById('calcBtn') as HTMLButtonElement | null;
    const saveBtn = document.getElementById('saveWatchlistBtn') as HTMLButtonElement | null;
    const errorBox = document.getElementById('errorBox') as HTMLElement | null;
    const resultBox = document.getElementById('resultBox') as HTMLElement | null;
    const watchlistBox = document.getElementById('watchlistBox') as HTMLElement | null;
    const startDateEl = document.getElementById('startDate') as HTMLInputElement | null;
    const endDateEl = document.getElementById('endDate') as HTMLInputElement | null;
    const chartSection = document.getElementById('chartSection') as HTMLElement | null;
    const chartContainer = document.getElementById('chartContainer') as HTMLElement | null;
    const chartInfo = document.getElementById('chartInfo') as HTMLElement | null;
    
    let chartInstance: ReturnType<typeof createChart> | null = null;

    const MIN_DATE = '2000-01-01'; // æœ€æ—©æ—¥æœŸé™åˆ¶
    
    function todayIso() {
      return new Date().toISOString().slice(0, 10);
    }
    function yearsAgoIso(years: number) {
      const d = new Date();
      d.setFullYear(d.getFullYear() - years);
      const dateStr = d.toISOString().slice(0, 10);
      // ç¡®ä¿ä¸æ—©äºæœ€å°æ—¥æœŸ
      return dateStr < MIN_DATE ? MIN_DATE : dateStr;
    }

    if (startDateEl) {
      startDateEl.min = MIN_DATE;
      startDateEl.value = yearsAgoIso(10);
    }
    if (endDateEl) {
      endDateEl.min = MIN_DATE;
      endDateEl.value = todayIso();
    }

    function showError(msg: string) {
      if (!errorBox) return;
      errorBox.textContent = msg || 'å‘ç”Ÿé”™è¯¯';
      errorBox.classList.remove('hidden');
    }
    function clearError() {
      if (!errorBox) return;
      errorBox.classList.add('hidden');
      errorBox.textContent = '';
    }

    // æ•°å­—æ ¼å¼åŒ–ï¼šåƒåˆ†ä½ + ä¸¤ä½å°æ•°
    function formatNumber(n: number, decimals = 2): string {
      if (!Number.isFinite(n)) return '0.00';
      return n.toLocaleString('en-US', { 
        minimumFractionDigits: decimals, 
        maximumFractionDigits: decimals 
      });
    }
    
    function renderResults(data: any, weights: Array<{ symbol: string; weight: number }>) {
      const fmt = (n: number, decimals = 2) => formatNumber(n, decimals);
      const fmtPct = (n: number) => {
        const val = Number.isFinite(n) ? n : 0;
        const sign = val >= 0 ? '+' : '';
        return `${sign}${fmt(val)}%`;
      };
      
      const cagr = data.cagr || 0;
      const totalReturn = data.totalReturn || 0;
      const maxDrawdown = data.maxDrawdown || 0;
      const sharpe = data.sharpeRatio || 0;
      
      const cagrColor = cagr >= 0 ? 'text-green-600' : 'text-red-500';
      const returnColor = totalReturn >= 0 ? 'text-green-600' : 'text-red-500';
      
      // è®¡ç®—å¹´æ•°
      const startTs = Date.parse(data.actualStartDate);
      const endTs = Date.parse(data.actualEndDate);
      const years = ((endTs - startTs) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1);
      
      // è®¡ç®—æ€»æƒé‡ç”¨äºæ˜¾ç¤ºå æ¯”
      const totalWeight = weights.reduce((sum, w) => sum + w.weight, 0);
      
      // ç”Ÿæˆç»„åˆæˆåˆ†ï¼ˆåŒ…å«å…¥åœºæ—¥æœŸï¼‰
      const entryEvents = data.entryEvents || [];
      const entryDateBySymbol: Record<string, string> = {};
      for (const e of entryEvents) {
        entryDateBySymbol[e.symbol] = e.date;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨æ€å…¥åœºï¼ˆä¸åŒå…¥åœºæ—¥æœŸï¼‰
      const uniqueEntryDates = new Set(entryEvents.map((e: any) => e.date));
      const hasDynamicEntry = uniqueEntryDates.size > 1;
      
      const holdingsHtml = weights.map(w => {
        const pct = totalWeight > 0 ? ((w.weight / totalWeight) * 100).toFixed(1) : '0';
        const provider = data.providerBySymbol?.[w.symbol] || 'unknown';
        const isCached = provider.includes('cache');
        const entryDate = entryDateBySymbol[w.symbol];
        const isLateEntry = entryDate && entryDate !== data.actualStartDate;
        
        return `
          <div class="flex items-center justify-between py-2 border-b border-black/5 last:border-0">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="font-semibold text-onekey-text-primary font-mono">${w.symbol}</span>
              ${isCached ? '<span class="text-xs px-1.5 py-0.5 bg-green-100 text-green-700 rounded">ç¼“å­˜</span>' : ''}
              ${isLateEntry ? `<span class="text-xs px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded font-mono">${entryDate} å…¥åœº</span>` : ''}
            </div>
            <span class="text-onekey-text-secondary font-mono">${pct}%</span>
          </div>
        `;
      }).join('');
      
      return `
        <!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
          <div class="bg-white rounded-xl p-4 border border-black/5 shadow-sm">
            <div class="text-xs text-onekey-text-muted uppercase tracking-wide mb-1">å¹´åŒ–æ”¶ç›Š CAGR</div>
            <div class="text-2xl font-bold font-mono ${cagrColor}">${fmtPct(cagr)}</div>
          </div>
          <div class="bg-white rounded-xl p-4 border border-black/5 shadow-sm">
            <div class="text-xs text-onekey-text-muted uppercase tracking-wide mb-1">æ€»æ”¶ç›Š</div>
            <div class="text-2xl font-bold font-mono ${returnColor}">${fmtPct(totalReturn)}</div>
          </div>
          <div class="bg-white rounded-xl p-4 border border-black/5 shadow-sm">
            <div class="text-xs text-onekey-text-muted uppercase tracking-wide mb-1">æœ€å¤§å›æ’¤</div>
            <div class="text-2xl font-bold font-mono text-red-500">-${fmt(maxDrawdown)}%</div>
          </div>
          <div class="bg-white rounded-xl p-4 border border-black/5 shadow-sm">
            <div class="text-xs text-onekey-text-muted uppercase tracking-wide mb-1">å¤æ™®æ¯”ç‡</div>
            <div class="text-2xl font-bold font-mono text-onekey-text-primary">${fmt(sharpe, 3)}</div>
          </div>
        </div>
        
        <!-- è¯¦ç»†ä¿¡æ¯ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- å›æµ‹åŒºé—´ -->
          <div class="bg-white/50 rounded-xl p-4 border border-black/5">
            <div class="text-sm font-semibold text-onekey-text-primary mb-3">ğŸ“… å›æµ‹åŒºé—´</div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-onekey-text-secondary">èµ·å§‹æ—¥æœŸ</span>
                <span class="text-onekey-text-primary font-medium font-mono">${data.actualStartDate}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-onekey-text-secondary">ç»“æŸæ—¥æœŸ</span>
                <span class="text-onekey-text-primary font-medium font-mono">${data.actualEndDate}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-onekey-text-secondary">å›æµ‹å¹´æ•°</span>
                <span class="text-onekey-text-primary font-medium font-mono">${years} å¹´</span>
              </div>
            </div>
          </div>
          
          <!-- ç»„åˆæˆåˆ† -->
          <div class="bg-white/50 rounded-xl p-4 border border-black/5">
            <div class="text-sm font-semibold text-onekey-text-primary mb-3">ğŸ“Š ç»„åˆæˆåˆ†</div>
            <div class="text-sm">
              ${holdingsHtml}
            </div>
          </div>
        </div>
        
        <!-- åŠ¨æ€å…¥åœºæç¤º -->
        ${hasDynamicEntry ? `
        <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
          <div class="flex items-start gap-2">
            <span class="text-amber-600">âš¡</span>
            <div class="text-sm text-amber-800">
              <div class="font-medium mb-1">åŠ¨æ€å…¥åœºæ¨¡å¼</div>
              <div class="text-xs text-amber-700">
                éƒ¨åˆ†è‚¡ç¥¨åœ¨å›æµ‹æœŸé—´æ‰ä¸Šå¸‚ï¼Œç³»ç»Ÿè‡ªåŠ¨åœ¨å…¶ä¸Šå¸‚æ—¥åŠ å…¥ç»„åˆå¹¶é‡æ–°å¹³è¡¡æƒé‡ã€‚
                æ ‡æœ‰ <span class="px-1 py-0.5 bg-amber-100 rounded">å…¥åœº</span> æ ‡ç­¾çš„è‚¡ç¥¨æ™šäºå›æµ‹èµ·å§‹æ—¥ä¸Šå¸‚ã€‚
              </div>
            </div>
          </div>
        </div>
        ` : ''}
        
        <!-- å¤‡æ³¨ä¿¡æ¯ -->
        <div class="mt-4 text-xs text-onekey-text-muted">
          <div class="flex items-center gap-1">
            <span>ğŸ’¡</span>
            <span>æ•°æ®æ¥æº: Yahoo Finance (Adjusted Close, å·²è°ƒæ•´åˆ†çº¢å’Œæ‹†è‚¡) Â· ç¼“å­˜ 24 å°æ—¶</span>
          </div>
        </div>
      `;
    }

    function createRow(symbol = '', weight = '') {
      const row = document.createElement('div');
      row.className = 'grid grid-cols-12 gap-2 items-center';
      row.innerHTML = `
        <input class="col-span-7 px-3 py-2 bg-white border border-black/10 rounded-lg text-sm" placeholder="ä¾‹å¦‚ï¼šNVDA" value="${symbol}" />
        <input class="col-span-4 px-3 py-2 bg-white border border-black/10 rounded-lg text-sm number" placeholder="æƒé‡" value="${weight}" />
        <button class="col-span-1 text-sm px-2 py-2 rounded-lg border border-black/10 hover:border-red-400/60" type="button">Ã—</button>
      `;
      const [symEl, _wEl, delBtn] = Array.from(row.children) as [
        HTMLInputElement,
        HTMLInputElement,
        HTMLButtonElement
      ];
      symEl.addEventListener('input', () => {
        symEl.value = String(symEl.value || '').toUpperCase();
      });
      delBtn.addEventListener('click', () => row.remove());
      return row;
    }

    function addDefaultRows() {
      if (!rowsEl) return;
      rowsEl.appendChild(createRow('NVDA', '1'));
      rowsEl.appendChild(createRow('TSLA', '1'));
      rowsEl.appendChild(createRow('GOOGL', '1'));
    }

    function collectWeights() {
      const items: Array<{ symbol: string; weight: number }> = [];
      if (!rowsEl) return items;
      for (const rowEl of Array.from(rowsEl.children)) {
        const row = rowEl as HTMLElement;
        const symInput = row.children[0] as HTMLInputElement | undefined;
        const weightInput = row.children[1] as HTMLInputElement | undefined;
        const sym = symInput?.value?.trim();
        const wRaw = weightInput?.value?.trim();
        if (!sym) continue;
        const w = Number(wRaw);
        if (!Number.isFinite(w) || w <= 0) continue;
        items.push({ symbol: sym, weight: w });
      }
      return items;
    }

    async function loadWatchlist() {
      if (!watchlistBox) return;
      try {
        const resp = await fetch('/api/profile/watchlist', { credentials: 'include' });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(data?.error || `HTTP ${resp.status}`);
        const items = data?.items || [];
        if (!Array.isArray(items) || items.length === 0) {
          watchlistBox.textContent = 'æš‚æ— æ ‡çš„ã€‚ä½ å¯ä»¥åœ¨å›æµ‹é¡µç‚¹å‡»â€œå†™å…¥æ ‡çš„æ± â€ã€‚';
          return;
        }
        watchlistBox.innerHTML = '';
        for (const it of items) {
          const btn = document.createElement('button');
          const tags = Array.isArray(it.tags) && it.tags.length ? ` Â· ${it.tags.join(', ')}` : '';
          btn.type = 'button';
          btn.className = 'w-full text-left px-3 py-2 rounded-lg border border-black/10 bg-white hover:border-onekey-accent-green/30';
          btn.textContent = `${it.symbol}${tags}`;
          btn.addEventListener('click', () => {
            if (!rowsEl) return;
            rowsEl.appendChild(createRow(it.symbol, '1'));
          });
          watchlistBox.appendChild(btn);
        }
      } catch (e) {
        watchlistBox.textContent = 'åŠ è½½å¤±è´¥ï¼ˆè¯·ç¡®è®¤ KV å·²ç»‘å®šï¼‰ã€‚';
      }
    }

    async function saveToWatchlist() {
      clearError();
      const items = collectWeights().map((x) => ({
        symbol: x.symbol,
        tags: ['from-stocks'],
      }));
      if (items.length === 0) {
        showError('è¯·å…ˆå¡«å†™è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆæ ‡çš„å’Œæƒé‡');
        return;
      }
      try {
        const resp = await fetch('/api/profile/watchlist', {
          method: 'PUT',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ upsert: items }),
          credentials: 'include',
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(data?.error || `HTTP ${resp.status}`);
        await loadWatchlist();
      } catch (e) {
        showError('å†™å…¥æ ‡çš„æ± å¤±è´¥');
      }
    }

    async function calculate() {
      clearError();
      if (resultBox) resultBox.textContent = 'è®¡ç®—ä¸­...';
      const weights = collectWeights();
      const startDate = startDateEl?.value;
      const endDate = endDateEl?.value;

      if (!startDate || !endDate) {
        showError('è¯·é€‰æ‹©å¼€å§‹/ç»“æŸæ—¥æœŸ');
        return;
      }
      
      // éªŒè¯æ—¥æœŸä¸æ—©äº 2000-01-01
      if (startDate < MIN_DATE) {
        showError(`å¼€å§‹æ—¥æœŸä¸èƒ½æ—©äº ${MIN_DATE}`);
        return;
      }
      
      if (endDate < MIN_DATE) {
        showError(`ç»“æŸæ—¥æœŸä¸èƒ½æ—©äº ${MIN_DATE}`);
        return;
      }
      
      if (weights.length === 0) {
        showError('è¯·å¡«å†™è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆæ ‡çš„ä¸æƒé‡');
        return;
      }

      try {
        const resp = await fetch('/api/stocks/calculate', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ weights, startDate, endDate }),
          credentials: 'include',
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(data?.error || `HTTP ${resp.status}`);

        if (resultBox) {
          resultBox.innerHTML = renderResults(data, weights);
        }
        
        // æ¸²æŸ“å›¾è¡¨
        renderChart(data);
      } catch (e) {
        const msg = e instanceof Error ? e.message : String(e);
        showError(msg);
        if (resultBox) resultBox.innerHTML = '<div class="text-red-500">è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥ã€‚</div>';
        if (chartSection) chartSection.style.display = 'none';
      }
    }
    
    function renderChart(data: any) {
      if (!chartContainer || !chartSection) return;
      
      const valueSeries = data.valueSeries;
      const benchmarkSeries = data.benchmarkSeries;
      const maxDrawdownInfo = data.maxDrawdownInfo;
      
      if (!valueSeries || valueSeries.length < 2) {
        chartSection.style.display = 'none';
        return;
      }
      
      // æ˜¾ç¤ºå›¾è¡¨åŒºåŸŸ
      chartSection.style.display = 'block';
      
      // é”€æ¯æ—§å›¾è¡¨
      if (chartInstance) {
        chartInstance.remove();
        chartInstance = null;
      }
      
      // åˆ›å»ºæ–°å›¾è¡¨
      chartInstance = createChart(chartContainer, {
        width: chartContainer.clientWidth,
        height: 400,
        layout: {
          background: { color: 'transparent' },
          textColor: '#6b7280',
          fontFamily: "Georgia, 'Times New Roman', serif",
        },
        grid: {
          vertLines: { color: 'rgba(0,0,0,0.03)' },
          horzLines: { color: 'rgba(0,0,0,0.03)' },
        },
        rightPriceScale: {
          borderColor: 'rgba(0,0,0,0.1)',
        },
        timeScale: {
          borderColor: 'rgba(0,0,0,0.1)',
          timeVisible: false,
        },
        crosshair: {
          horzLine: { labelBackgroundColor: '#10b981' },
          vertLine: { labelBackgroundColor: '#10b981' },
        },
      });
      
      // è½¬æ¢æ—¥æœŸæ ¼å¼ä¸º Lightweight Charts éœ€è¦çš„æ ¼å¼
      const toChartData = (series: Array<{ date: string; value: number }>) => 
        series.map(p => ({ time: p.date, value: p.value }));
      
      // ç»„åˆå‡€å€¼æ›²çº¿ï¼ˆç»¿è‰²çº¿ï¼Œæ”¯æŒ markersï¼‰
      // å›¾è¡¨æ•°å­—æ ¼å¼åŒ–å‡½æ•°
      const chartFormatter = (p: number) => p.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      
      const portfolioSeries = chartInstance.addSeries(LineSeries, {
        color: '#10b981',
        lineWidth: 2,
        priceFormat: { type: 'custom', formatter: chartFormatter },
      });
      portfolioSeries.setData(toChartData(valueSeries));
      
      // QQQ åŸºå‡†æ›²çº¿ï¼ˆè“è‰²è™šçº¿ï¼‰
      if (benchmarkSeries && benchmarkSeries.length > 0) {
        const benchmarkLine = chartInstance.addSeries(LineSeries, {
          color: '#60a5fa',
          lineWidth: 1,
          lineStyle: 2, // è™šçº¿
          priceFormat: { type: 'custom', formatter: chartFormatter },
        });
        benchmarkLine.setData(toChartData(benchmarkSeries));
      }
      
      // æœ€å¤§å›æ’¤æ ‡æ³¨ï¼ˆä½¿ç”¨ v5 API: createSeriesMarkersï¼‰
      if (maxDrawdownInfo && maxDrawdownInfo.drawdownPct > 0) {
        const peakIdx = valueSeries.findIndex((p: any) => p.date === maxDrawdownInfo.peakDate);
        const troughIdx = valueSeries.findIndex((p: any) => p.date === maxDrawdownInfo.troughDate);
        
        if (peakIdx >= 0 && troughIdx >= 0) {
          createSeriesMarkers(portfolioSeries, [
            {
              time: maxDrawdownInfo.peakDate,
              position: 'aboveBar',
              color: '#ef4444',
              shape: 'arrowDown',
              text: 'å³°å€¼',
            },
            {
              time: maxDrawdownInfo.troughDate,
              position: 'belowBar',
              color: '#ef4444',
              shape: 'arrowUp',
              text: `-${maxDrawdownInfo.drawdownPct.toFixed(1)}%`,
            },
          ]);
        }
        
        if (chartInfo) {
          const recoveryText = maxDrawdownInfo.recoveryDate 
            ? `æ¢å¤æ—¥æœŸ: <span class="font-mono">${maxDrawdownInfo.recoveryDate}</span>` 
            : 'å°šæœªæ¢å¤è‡³å³°å€¼';
          chartInfo.innerHTML = `
            <span class="text-red-500 font-medium">æœ€å¤§å›æ’¤åŒºé—´:</span> 
            <span class="font-mono">${maxDrawdownInfo.peakDate}</span> â†’ <span class="font-mono">${maxDrawdownInfo.troughDate}</span> 
            <span class="text-onekey-text-muted">(${recoveryText})</span>
          `;
        }
      }
      
      // è‡ªé€‚åº”å®¹å™¨å¤§å°
      chartInstance.timeScale().fitContent();
      
      // ç›‘å¬çª—å£å¤§å°å˜åŒ–
      const resizeObserver = new ResizeObserver(() => {
        if (chartInstance && chartContainer) {
          chartInstance.resize(chartContainer.clientWidth, 400);
        }
      });
      resizeObserver.observe(chartContainer);
    }

    if (addRowBtn) addRowBtn.addEventListener('click', () => rowsEl?.appendChild(createRow('', '1')));
    if (calcBtn) calcBtn.addEventListener('click', calculate);
    if (saveBtn) saveBtn.addEventListener('click', saveToWatchlist);

    addDefaultRows();
    loadWatchlist();
  </script>
</AppLayout>


