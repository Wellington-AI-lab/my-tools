---
import AppLayout from '@/layouts/AppLayout.astro';
---

<AppLayout title="è‚¡ç¥¨ç»„åˆæ¨¡æ‹Ÿæ”¶ç›Šç‡å›æµ‹">
  <div class="titan-stocks-grid">
    <div class="titan-stocks-main">
      <div class="titan-card">
        <h1 class="titan-heading titan-heading-2 titan-text-center">è‚¡ç¥¨ç»„åˆæ¨¡æ‹Ÿæ”¶ç›Šç‡å›æµ‹</h1>

        <div class="titan-form">
          <div class="titan-date-inputs">
            <div class="titan-input-group">
              <label class="titan-label">å¼€å§‹æ—¥æœŸ</label>
              <input id="startDate" type="date" min="2000-01-01" class="titan-input" />
            </div>
            <div class="titan-input-group">
              <label class="titan-label">ç»“æŸæ—¥æœŸ</label>
              <input id="endDate" type="date" min="2000-01-01" class="titan-input" />
            </div>
          </div>

          <div class="titan-portfolio-input">
            <div class="titan-portfolio-header">
              <div class="titan-portfolio-title">èµ„äº§ç»„åˆåŠæƒé‡</div>
              <button id="addRowBtn" class="titan-btn titan-btn-ghost titan-btn-sm" type="button">
                + æ·»åŠ ä¸€è¡Œ
              </button>
            </div>

            <div class="titan-portfolio-body">
              <div id="rows" class="titan-rows"></div>
              <div class="titan-hint">
                æç¤ºï¼šæƒé‡ä¼šè‡ªåŠ¨å½’ä¸€åŒ–ï¼ˆä¸è¦æ±‚æ€»å’Œ=100ï¼‰ã€‚å»ºè®®å¸¸ç”¨ â‰¤10 åªã€‚
              </div>
            </div>
          </div>

          <div id="errorBox" class="titan-error hidden"></div>
          <button id="calcBtn" class="titan-btn titan-btn-primary" type="button">
            è®¡ç®—ï¼ˆCAGR / æ€»æ”¶ç›Š / æœ€å¤§å›æ’¤ / å¤æ™®ï¼‰
          </button>
        </div>
      </div>
    </div>

    <div class="titan-stocks-sidebar">
      <div class="titan-card">
        <h2 class="titan-heading titan-heading-3">ç¾è‚¡å¸‚å€¼å‰äºŒåï¼ˆæˆªè‡³2025å¹´æœ«ï¼‰</h2>
        <div id="watchlistBox" class="titan-watchlist">
          åŠ è½½ä¸­...
        </div>
      </div>
    </div>
  </div>

  <!-- å›æµ‹ç»“æœä¸å‡€å€¼èµ°åŠ¿å›¾å¹¶æ’ -->
  <div class="titan-results-grid">
    <div class="titan-card" id="resultSection">
      <h2 class="titan-heading titan-heading-3 titan-text-center">å›æµ‹ç»“æœ</h2>
      <div id="resultBox" class="titan-result-placeholder">
        å°šæœªè®¡ç®—ã€‚ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹å›æµ‹ã€‚
      </div>
    </div>

    <!-- å‡€å€¼èµ°åŠ¿å›¾ -->
    <div class="titan-card titan-chart-card" id="chartSection" style="display: none;">
      <h2 class="titan-heading titan-heading-3 titan-text-center">å‡€å€¼èµ°åŠ¿å›¾</h2>
      <div class="titan-legend">
        <div class="titan-legend-item">
          <div class="titan-legend-line titan-legend-portfolio"></div>
          <span>ç»„åˆ</span>
        </div>
        <div class="titan-legend-item">
          <div class="titan-legend-line titan-legend-benchmark"></div>
          <span>QQQ åŸºå‡†</span>
        </div>
        <div class="titan-legend-item">
          <div class="titan-legend-box"></div>
          <span>æœ€å¤§å›æ’¤åŒºé—´</span>
        </div>
      </div>
      <div id="chartContainer" class="titan-chart"></div>
      <div id="chartInfo" class="titan-chart-info"></div>
    </div>
  </div>

  <style is:global>
    /* Titan Stocks Page Styles */
    .titan-stocks-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 1024px) {
      .titan-stocks-grid {
        grid-template-columns: 2fr 1fr;
      }
    }

    .titan-stocks-main {
      display: flex;
      flex-direction: column;
    }

    .titan-stocks-sidebar {
      display: flex;
      flex-direction: column;
    }

    .titan-text-center {
      text-align: center;
    }

    .titan-form {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .titan-date-inputs {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 768px) {
      .titan-date-inputs {
        grid-template-columns: 1fr 1fr;
      }
    }

    .titan-input-group {
      display: flex;
      flex-direction: column;
    }

    .titan-label {
      font-size: 0.875rem;
      color: #6B7280;
      margin-bottom: 4px;
    }

    .titan-input {
      padding: 8px 12px;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      font-size: 0.875rem;
      background: #FFFFFF;
    }

    .titan-portfolio-input {
      border: 1px solid #E5E7EB;
      border-radius: 16px;
      overflow: hidden;
    }

    .titan-portfolio-header {
      background: #FAFAFA;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .titan-portfolio-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: #1F2937;
    }

    .titan-portfolio-body {
      padding: 16px;
      background: #FFFFFF;
    }

    .titan-rows {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .titan-hint {
      margin-top: 12px;
      font-size: 0.75rem;
      color: #6B7280;
    }

    .titan-error {
      font-size: 0.875rem;
      color: #DC2626;
    }

    .titan-watchlist {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    /* Buttons */
    .titan-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms;
      border: none;
    }

    .titan-btn-sm {
      padding: 4px 12px;
      font-size: 0.75rem;
    }

    .titan-btn-primary {
      background: #10B981;
      color: white;
    }

    .titan-btn-primary:hover {
      opacity: 0.9;
    }

    .titan-btn-ghost {
      background: white;
      border: 1px solid #E5E7EB;
      color: #374151;
    }

    .titan-btn-ghost:hover {
      background: #FAFAFA;
    }

    /* Results */
    .titan-results-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    @media (min-width: 1024px) {
      .titan-results-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .titan-result-placeholder {
      font-size: 0.875rem;
      color: #6B7280;
    }

    /* Chart */
    .titan-chart-card {
      height: fit-content;
    }

    .titan-legend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      font-size: 0.75rem;
      margin-bottom: 16px;
    }

    .titan-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .titan-legend-line {
      width: 12px;
      height: 2px;
      border-radius: 1px;
    }

    .titan-legend-portfolio {
      background: #22c55e;
    }

    .titan-legend-benchmark {
      background: #60a5fa;
    }

    .titan-legend-box {
      width: 12px;
      height: 12px;
      background: #FEE2E2;
      border: 1px solid #FCA5A5;
      border-radius: 4px;
    }

    .titan-chart {
      height: 350px;
      width: 100%;
    }

    .titan-chart-info {
      margin-top: 12px;
      font-size: 0.75rem;
      color: #6B7280;
      text-align: center;
    }

    /* Card */
    .titan-card {
      background: #FFFFFF;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid #E5E7EB;
    }

    .titan-heading {
      font-weight: 600;
      color: #1F2937;
    }

    .titan-heading-2 {
      font-size: 1.5rem;
    }

    .titan-heading-3 {
      font-size: 1.125rem;
    }
  </style>

  <script>
    import { createChart, LineSeries, createSeriesMarkers } from 'lightweight-charts';

    const rowsEl = document.getElementById('rows') as HTMLElement | null;
    const addRowBtn = document.getElementById('addRowBtn') as HTMLButtonElement | null;
    const calcBtn = document.getElementById('calcBtn') as HTMLButtonElement | null;
    const errorBox = document.getElementById('errorBox') as HTMLElement | null;
    const resultBox = document.getElementById('resultBox') as HTMLElement | null;
    const watchlistBox = document.getElementById('watchlistBox') as HTMLElement | null;
    const startDateEl = document.getElementById('startDate') as HTMLInputElement | null;
    const endDateEl = document.getElementById('endDate') as HTMLInputElement | null;
    const chartSection = document.getElementById('chartSection') as HTMLElement | null;
    const chartContainer = document.getElementById('chartContainer') as HTMLElement | null;
    const chartInfo = document.getElementById('chartInfo') as HTMLElement | null;

    let chartInstance: ReturnType<typeof createChart> | null = null;
    let chartResizeObserver: ResizeObserver | null = null;

    const MIN_DATE = '2000-01-01'; // æœ€æ—©æ—¥æœŸé™åˆ¶

    // HTML è½¬ä¹‰é˜²æ­¢ XSS
    function escapeHtml(str: string): string {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function todayIso() {
      return new Date().toISOString().slice(0, 10);
    }
    function _yearsAgoIso(years: number) {
      const d = new Date();
      d.setFullYear(d.getFullYear() - years);
      const dateStr = d.toISOString().slice(0, 10);
      // ç¡®ä¿ä¸æ—©äºæœ€å°æ—¥æœŸ
      return dateStr < MIN_DATE ? MIN_DATE : dateStr;
    }

    if (startDateEl) {
      startDateEl.min = MIN_DATE;
      startDateEl.value = '2010-01-01';
    }
    if (endDateEl) {
      endDateEl.min = MIN_DATE;
      endDateEl.value = todayIso();
    }

    function showError(msg: string) {
      if (!errorBox) return;
      errorBox.textContent = msg || 'å‘ç”Ÿé”™è¯¯';
      errorBox.classList.remove('hidden');
    }
    function clearError() {
      if (!errorBox) return;
      errorBox.classList.add('hidden');
      errorBox.textContent = '';
    }

    // è‡ªåŠ¨è°ƒæ•´æŒ‡æ ‡æ•°å­—å­—ä½“å¤§å°ï¼Œä½¿å…¶å®Œæ•´æ˜¾ç¤ºï¼Œå¹¶ç»Ÿä¸€æ‰€æœ‰æŒ‡æ ‡çš„å­—ä½“å¤§å°
    function fitMetricValues() {
      requestAnimationFrame(() => {
        const metricValues = document.querySelectorAll('.metric-value');
        const minFontSizes: number[] = [];

        // ç¬¬ä¸€æ­¥ï¼šè®¡ç®—æ¯ä¸ªæŒ‡æ ‡éœ€è¦çš„å­—ä½“å¤§å°
        metricValues.forEach((el) => {
          const element = el as HTMLElement;
          const parent = element.parentElement;
          if (!parent) return;

          // é‡ç½®å­—ä½“å¤§å°
          element.style.fontSize = '';

          // è·å–å¯ç”¨å®½åº¦ï¼ˆçˆ¶å…ƒç´ å®½åº¦å‡å» paddingï¼‰
          const parentStyle = getComputedStyle(parent);
          const paddingLeft = parseFloat(parentStyle.paddingLeft) || 0;
          const paddingRight = parseFloat(parentStyle.paddingRight) || 0;
          const availableWidth = parent.clientWidth - paddingLeft - paddingRight;

          // è·å–å½“å‰å­—ä½“å¤§å°
          let fontSize = parseFloat(getComputedStyle(element).fontSize);
          const minFontSize = 14; // æœ€å°å­—ä½“å¤§å°

          // å¦‚æœå†…å®¹è¶…å‡ºï¼Œé€æ­¥ç¼©å°å­—ä½“
          while (element.scrollWidth > availableWidth && fontSize > minFontSize) {
            fontSize -= 1;
            element.style.fontSize = `${fontSize}px`;
          }

          minFontSizes.push(fontSize);
        });

        // ç¬¬äºŒæ­¥ï¼šæ‰¾å‡ºæœ€å°çš„å­—ä½“å¤§å°ï¼Œåº”ç”¨åˆ°æ‰€æœ‰æŒ‡æ ‡
        if (minFontSizes.length > 0) {
          const uniformSize = Math.min(...minFontSizes);
          metricValues.forEach((el) => {
            (el as HTMLElement).style.fontSize = `${uniformSize}px`;
          });
        }
      });
    }

    // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è°ƒæ•´ï¼ˆå¸¦é˜²æŠ–ï¼‰
    let resizeTimeout: ReturnType<typeof setTimeout> | null = null;
    window.addEventListener('resize', () => {
      if (document.querySelector('.metric-value')) {
        if (resizeTimeout) clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(fitMetricValues, 100);
      }
    });

    // æ•°å­—æ ¼å¼åŒ–ï¼šåƒåˆ†ä½ + ä¸¤ä½å°æ•°
    function formatNumber(n: number, decimals = 2): string {
      if (!Number.isFinite(n)) return '0.00';
      return n.toLocaleString('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    function renderResults(data: any, weights: Array<{ symbol: string; weight: number }>) {
      const fmt = (n: number, decimals = 2) => formatNumber(n, decimals);
      const fmtPct = (n: number) => {
        const val = Number.isFinite(n) ? n : 0;
        const sign = val >= 0 ? '+' : '';
        return `${sign}${fmt(val, 0)}%`;
      };

      const cagr = data.cagr || 0;
      const totalReturn = data.totalReturn || 0;
      const maxDrawdown = data.maxDrawdown || 0;
      const sharpe = data.sharpeRatio || 0;

      const cagrColor = cagr >= 0 ? 'text-green-600' : 'text-red-500';
      const returnColor = totalReturn >= 0 ? 'text-green-600' : 'text-red-500';

      // è®¡ç®—å¹´æ•°
      const startTs = Date.parse(data.actualStartDate);
      const endTs = Date.parse(data.actualEndDate);
      const years = ((endTs - startTs) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1);

      // è®¡ç®—æ€»æƒé‡ç”¨äºæ˜¾ç¤ºå æ¯”
      const totalWeight = weights.reduce((sum, w) => sum + w.weight, 0);

      // ç”Ÿæˆç»„åˆæˆåˆ†ï¼ˆåŒ…å«å…¥åœºæ—¥æœŸï¼‰
      const entryEvents = data.entryEvents || [];
      const entryDateBySymbol: Record<string, string> = {};
      for (const e of entryEvents) {
        entryDateBySymbol[e.symbol] = e.date;
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨æ€å…¥åœºï¼ˆä¸åŒå…¥åœºæ—¥æœŸï¼‰
      const uniqueEntryDates = new Set(entryEvents.map((e: any) => e.date));
      const hasDynamicEntry = uniqueEntryDates.size > 1;

      const holdingsHtml = weights.map(w => {
        const pct = totalWeight > 0 ? ((w.weight / totalWeight) * 100).toFixed(1) : '0';
        const provider = data.providerBySymbol?.[w.symbol] || 'unknown';
        const isCached = provider.includes('cache');
        const entryDate = entryDateBySymbol[w.symbol];
        const isLateEntry = entryDate && entryDate !== data.actualStartDate;
        const safeSymbol = escapeHtml(w.symbol);

        return `
          <div class="flex items-center justify-between py-2 border-b border-black/5 last:border-0">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="font-semibold text-onekey-text-primary font-mono">${safeSymbol}</span>
              ${isCached ? '<span class="text-xs px-1.5 py-0.5 bg-green-100 text-green-700 rounded">ç¼“å­˜</span>' : ''}
              ${isLateEntry ? `<span class="text-xs px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded font-mono">${escapeHtml(entryDate)} å…¥åœº</span>` : ''}
            </div>
            <span class="text-onekey-text-secondary font-mono">${pct}%</span>
          </div>
        `;
      }).join('');

      return `
        <!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mt-6 mb-6">
          <div class="bg-white rounded-xl p-4 border border-black/5 shadow-sm">
            <div class="text-xs text-onekey-text-muted uppercase tracking-wide mb-2 text-center h-4">å¹´åŒ–æ”¶ç›Š CAGR</div>
            <div class="metric-value text-2xl font-bold font-mono ${cagrColor} text-center">${fmtPct(cagr)}</div>
          </div>
          <div class="bg-white rounded-xl p-4 border border-black/5 shadow-sm">
            <div class="text-xs text-onekey-text-muted uppercase tracking-wide mb-2 text-center h-4">æ€»æ”¶ç›Š</div>
            <div class="metric-value text-4xl font-bold font-mono ${returnColor} text-center">${fmtPct(totalReturn)}</div>
          </div>
          <div class="bg-white rounded-xl p-4 border border-black/5 shadow-sm">
            <div class="text-xs text-onekey-text-muted uppercase tracking-wide mb-2 text-center h-4">æœ€å¤§å›æ’¤</div>
            <div class="metric-value text-2xl font-bold font-mono text-red-500 text-center">-${fmt(maxDrawdown, 0)}%</div>
          </div>
          <div class="bg-white rounded-xl p-4 border border-black/5 shadow-sm">
            <div class="text-xs text-onekey-text-muted uppercase tracking-wide mb-2 text-center h-4">å¤æ™®æ¯”ç‡</div>
            <div class="metric-value text-2xl font-bold font-mono text-onekey-text-primary text-center">${fmt(sharpe, 3)}</div>
          </div>
        </div>

        <!-- è¯¦ç»†ä¿¡æ¯ -->
        <div class="space-y-4">
          <!-- å›æµ‹åŒºé—´ -->
          <div class="bg-white/50 rounded-xl p-4 border border-black/5">
            <div class="text-sm font-semibold text-onekey-text-primary mb-3">ğŸ“… å›æµ‹åŒºé—´</div>
            <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm">
              <div class="flex gap-2">
                <span class="text-onekey-text-secondary">èµ·å§‹æ—¥æœŸ</span>
                <span class="text-onekey-text-primary font-medium font-mono">${data.actualStartDate}</span>
              </div>
              <div class="flex gap-2">
                <span class="text-onekey-text-secondary">ç»“æŸæ—¥æœŸ</span>
                <span class="text-onekey-text-primary font-medium font-mono">${data.actualEndDate}</span>
              </div>
              <div class="flex gap-2">
                <span class="text-onekey-text-secondary">å›æµ‹å¹´æ•°</span>
                <span class="text-onekey-text-primary font-medium font-mono">${years} å¹´</span>
              </div>
            </div>
          </div>

          <!-- ç»„åˆæˆåˆ† -->
          <div class="bg-white/50 rounded-xl p-4 border border-black/5">
            <div class="text-sm font-semibold text-onekey-text-primary mb-3">ğŸ“Š ç»„åˆæˆåˆ†</div>
            <div class="text-sm">
              ${holdingsHtml}
            </div>
          </div>
        </div>

        <!-- åŠ¨æ€å…¥åœºæç¤º -->
        ${hasDynamicEntry ? `
        <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
          <div class="flex items-start gap-2">
            <span class="text-amber-600">âš¡</span>
            <div class="text-sm text-amber-800">
              <div class="font-medium mb-1">åŠ¨æ€å…¥åœºæ¨¡å¼</div>
              <div class="text-xs text-amber-700">
                éƒ¨åˆ†è‚¡ç¥¨åœ¨å›æµ‹æœŸé—´æ‰ä¸Šå¸‚ï¼Œç³»ç»Ÿè‡ªåŠ¨åœ¨å…¶ä¸Šå¸‚æ—¥åŠ å…¥ç»„åˆå¹¶é‡æ–°å¹³è¡¡æƒé‡ã€‚
                æ ‡æœ‰ <span class="px-1 py-0.5 bg-amber-100 rounded">å…¥åœº</span> æ ‡ç­¾çš„è‚¡ç¥¨æ™šäºå›æµ‹èµ·å§‹æ—¥ä¸Šå¸‚ã€‚
              </div>
            </div>
          </div>
        </div>
        ` : ''}

        <!-- å¤‡æ³¨ä¿¡æ¯ -->
        <div class="mt-4 text-xs text-onekey-text-muted">
          <div class="flex items-center gap-1">
            <span>ğŸ’¡</span>
            <span>æ•°æ®æ¥æº: Yahoo Finance (Adjusted Close, å·²è°ƒæ•´åˆ†çº¢å’Œæ‹†è‚¡) Â· ç¼“å­˜ 24 å°æ—¶</span>
          </div>
        </div>
      `;
    }

    function createRow(symbol = '', weight = '') {
      const row = document.createElement('div');
      row.className = 'inline-flex items-center justify-center gap-1 px-3 py-2 bg-gray-50 border border-black/10 rounded-lg min-w-[120px]';
      row.innerHTML = `
        <input class="w-20 px-2 py-1 bg-white border border-black/5 rounded text-sm font-mono text-center min-w-[80px]" placeholder="ä»£ç " value="${escapeHtml(symbol)}" />
        <span class="text-gray-400 text-xs">:</span>
        <input class="w-12 px-1 py-1 bg-white border border-black/5 rounded text-sm text-center" placeholder="1" value="${escapeHtml(weight)}" />
        <button class="ml-1 w-5 h-5 flex items-center justify-center text-gray-400 hover:text-red-500 text-sm leading-none" type="button">Ã—</button>
      `;
      const [symEl, , _weightEl, delBtn] = Array.from(row.children) as [
        HTMLInputElement,
        HTMLSpanElement,
        HTMLInputElement,
        HTMLButtonElement
      ];
      symEl.addEventListener('input', () => {
        symEl.value = String(symEl.value || '').toUpperCase();
        const val = symEl.value.trim();
        // æ£€æŸ¥æ ¼å¼æ˜¯å¦æœ‰æ•ˆ æˆ– æ˜¯å¦é‡å¤
        const isInvalid = val && (!isValidSymbol(val) || isSymbolExists(val, symEl));
        if (isInvalid) {
          symEl.classList.add('border-red-400', 'bg-red-50');
          symEl.classList.remove('border-black/10', 'bg-white');
        } else {
          symEl.classList.remove('border-red-400', 'bg-red-50');
          symEl.classList.add('border-black/10', 'bg-white');
        }
      });
      delBtn.addEventListener('click', () => row.remove());
      return row;
    }

    function addDefaultRows() {
      if (!rowsEl) return;
      rowsEl.appendChild(createRow('NVDA', '1'));
      rowsEl.appendChild(createRow('TSLA', '1'));
      rowsEl.appendChild(createRow('GOOGL', '1'));
    }

    // éªŒè¯è‚¡ç¥¨ä»£ç æ ¼å¼ï¼ˆå¿…é¡»åŒ…å«å­—æ¯ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦ã€ç‚¹ï¼‰
    function isValidSymbol(symbol: string): boolean {
      if (!symbol) return false;
      // å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå­—æ¯
      if (!/[A-Za-z]/.test(symbol)) return false;
      // åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦ã€ç‚¹
      if (!/^[A-Za-z0-9.\-]+$/.test(symbol)) return false;
      return true;
    }

    function collectWeights() {
      const items: Array<{ symbol: string; weight: number }> = [];
      if (!rowsEl) return items;
      for (const rowEl of Array.from(rowsEl.children)) {
        const row = rowEl as HTMLElement;
        const symInput = row.children[0] as HTMLInputElement | undefined;
        const weightInput = row.children[2] as HTMLInputElement | undefined; // index 2 (è·³è¿‡å†’å· span)
        const sym = symInput?.value?.trim();
        const wRaw = weightInput?.value?.trim();
        if (!sym) continue;
        const w = Number(wRaw);
        if (!Number.isFinite(w) || w <= 0) continue;
        items.push({ symbol: sym, weight: w });
      }
      return items;
    }

    // è·å–å½“å‰å·²å­˜åœ¨çš„è‚¡ç¥¨ä»£ç ï¼ˆæ’é™¤æŒ‡å®šçš„è¾“å…¥æ¡†ï¼‰
    function getExistingSymbols(excludeInput?: HTMLInputElement): Set<string> {
      const symbols = new Set<string>();
      if (!rowsEl) return symbols;
      for (const rowEl of Array.from(rowsEl.children)) {
        const symInput = rowEl.children[0] as HTMLInputElement | undefined;
        if (symInput && symInput !== excludeInput) {
          const sym = symInput.value?.trim().toUpperCase();
          if (sym) symbols.add(sym);
        }
      }
      return symbols;
    }

    // æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦å·²å­˜åœ¨
    function isSymbolExists(symbol: string, excludeInput?: HTMLInputElement): boolean {
      return getExistingSymbols(excludeInput).has(symbol.toUpperCase());
    }

    // æ˜¾ç¤ºé‡å¤æç¤ºï¼ˆçŸ­æš‚é—ªçƒï¼‰
    function showDuplicateHint(symbol: string) {
      // é«˜äº®å·²å­˜åœ¨çš„è¡Œ
      if (!rowsEl) return;
      for (const rowEl of Array.from(rowsEl.children)) {
        const symInput = rowEl.children[0] as HTMLInputElement | undefined;
        if (symInput?.value?.trim().toUpperCase() === symbol.toUpperCase()) {
          const row = rowEl as HTMLElement;
          row.classList.add('ring-2', 'ring-amber-400', 'rounded-lg');
          setTimeout(() => row.classList.remove('ring-2', 'ring-amber-400', 'rounded-lg'), 1500);
          break;
        }
      }
    }

    // å›ºå®šçš„è§‚å¯Ÿæ± è‚¡ç¥¨åˆ—è¡¨
    const DEFAULT_WATCHLIST = [
      'NVDA', 'AAPL', 'GOOG', 'MSFT', 'AMZN', 'META', 'AVGO', 'TSLA', 'BRK-B', 'LLY',
      'JPM', 'WMT', 'V', 'ORCL', 'MA', 'XOM', 'JNJ', 'PLTR', 'BAC', 'ABBV'
    ];

    function loadWatchlist() {
      if (!watchlistBox) return;
      watchlistBox.innerHTML = '';
      for (const symbol of DEFAULT_WATCHLIST) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'min-w-[60px] h-9 px-3 py-1.5 text-sm font-mono font-medium rounded-lg border border-black/10 bg-white hover:border-onekey-accent-green/50 hover:bg-green-50 transition-colors flex items-center justify-center text-center';
        btn.textContent = symbol;
        btn.addEventListener('click', () => {
          if (!rowsEl) return;
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
          if (isSymbolExists(symbol)) {
            showDuplicateHint(symbol);
            return;
          }
          rowsEl.appendChild(createRow(symbol, '1'));
        });
        watchlistBox.appendChild(btn);
      }
    }

    let isCalculating = false;

    async function calculate() {
      // é˜²æ­¢é‡å¤è¯·æ±‚
      if (isCalculating) return;

      clearError();
      if (resultBox) resultBox.textContent = 'è®¡ç®—ä¸­...';
      const weights = collectWeights();
      const startDate = startDateEl?.value;
      const endDate = endDateEl?.value;

      if (!startDate || !endDate) {
        showError('è¯·é€‰æ‹©å¼€å§‹/ç»“æŸæ—¥æœŸ');
        return;
      }

      // éªŒè¯æ—¥æœŸä¸æ—©äº 2000-01-01
      if (startDate < MIN_DATE) {
        showError(`å¼€å§‹æ—¥æœŸä¸èƒ½æ—©äº ${MIN_DATE}`);
        return;
      }

      if (endDate < MIN_DATE) {
        showError(`ç»“æŸæ—¥æœŸä¸èƒ½æ—©äº ${MIN_DATE}`);
        return;
      }

      if (weights.length === 0) {
        showError('è¯·å¡«å†™è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆæ ‡çš„ä¸æƒé‡');
        return;
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„è‚¡ç¥¨ä»£ç 
      const symbolSet = new Set<string>();
      const duplicates: string[] = [];
      const invalidSymbols: string[] = [];
      for (const w of weights) {
        if (symbolSet.has(w.symbol)) {
          duplicates.push(w.symbol);
        }
        if (!isValidSymbol(w.symbol)) {
          invalidSymbols.push(w.symbol);
        }
        symbolSet.add(w.symbol);
      }
      if (invalidSymbols.length > 0) {
        showError(`è‚¡ç¥¨ä»£ç æ ¼å¼æ— æ•ˆï¼š${invalidSymbols.join(', ')}ï¼Œä»£ç å¿…é¡»åŒ…å«å­—æ¯`);
        return;
      }
      if (duplicates.length > 0) {
        showError(`å­˜åœ¨é‡å¤çš„è‚¡ç¥¨ä»£ç ï¼š${duplicates.join(', ')}ï¼Œè¯·åˆ é™¤é‡å¤é¡¹`);
        return;
      }

      // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
      isCalculating = true;
      if (calcBtn) {
        calcBtn.disabled = true;
        calcBtn.textContent = 'è®¡ç®—ä¸­...';
      }

      try {
        const resp = await fetch('/api/stocks/calculate', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ weights, startDate, endDate }),
          credentials: 'include',
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(data?.error || `HTTP ${resp.status}`);

        // æˆåŠŸæ—¶æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
        clearError();

        if (resultBox) {
          resultBox.innerHTML = renderResults(data, weights);
          // è‡ªåŠ¨è°ƒæ•´æŒ‡æ ‡æ•°å­—çš„å­—ä½“å¤§å°
          fitMetricValues();
        }

        // æ¸²æŸ“å›¾è¡¨
        renderChart(data);
      } catch (e) {
        let msg = e instanceof Error ? e.message : String(e);

        // ä¼˜åŒ–é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
        const providerFailMatch = msg.match(/All providers failed for ([\w-]+)/);
        const noPriceDataMatch = msg.match(/No usable price data.*for[:\s]*([\w-]+)/i);
        const insufficientDataMatch = msg.match(/Insufficient data for ([\w-]+)/i);

        if (providerFailMatch) {
          msg = `æœªæŸ¥è¯¢åˆ° ${providerFailMatch[1]}ï¼Œè¯·ä¿®æ­£ã€‚`;
        } else if (insufficientDataMatch) {
          msg = `${insufficientDataMatch[1]} æ•°æ®ä¸è¶³ï¼Œå¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„ç¾è‚¡ä»£ç ï¼Œè¯·ä¿®æ­£ã€‚`;
        } else if (noPriceDataMatch) {
          msg = `${noPriceDataMatch[1]} åœ¨æ‰€é€‰æ—¥æœŸèŒƒå›´å†…æ— æ•°æ®ï¼Œè¯·è°ƒæ•´æ—¥æœŸæˆ–è‚¡ç¥¨ä»£ç ã€‚`;
        } else if (msg.includes('Failed to fetch')) {
          msg = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
        }

        showError(msg);
        if (resultBox) resultBox.innerHTML = '<div class="text-red-500">è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥ã€‚</div>';
        if (chartSection) chartSection.style.display = 'none';
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        isCalculating = false;
        if (calcBtn) {
          calcBtn.disabled = false;
          calcBtn.textContent = 'è®¡ç®—ï¼ˆCAGR / æ€»æ”¶ç›Š / æœ€å¤§å›æ’¤ / å¤æ™®ï¼‰';
        }
      }
    }

    function renderChart(data: any) {
      if (!chartContainer || !chartSection) return;

      const valueSeries = data.valueSeries;
      const benchmarkSeries = data.benchmarkSeries;
      const maxDrawdownInfo = data.maxDrawdownInfo;

      if (!valueSeries || valueSeries.length < 2) {
        chartSection.style.display = 'none';
        return;
      }

      // æ˜¾ç¤ºå›¾è¡¨åŒºåŸŸ
      chartSection.style.display = 'block';

      // é”€æ¯æ—§å›¾è¡¨
      if (chartInstance) {
        chartInstance.remove();
        chartInstance = null;
      }

      // åˆ›å»ºæ–°å›¾è¡¨
      chartInstance = createChart(chartContainer, {
        width: chartContainer.clientWidth,
        height: 350,
        layout: {
          background: { color: 'transparent' },
          textColor: '#6b7280',
          fontFamily: "Georgia, 'Times New Roman', serif",
        },
        grid: {
          vertLines: { color: 'rgba(0,0,0,0.03)' },
          horzLines: { color: 'rgba(0,0,0,0.03)' },
        },
        rightPriceScale: {
          borderColor: 'rgba(0,0,0,0.1)',
        },
        timeScale: {
          borderColor: 'rgba(0,0,0,0.1)',
          timeVisible: false,
          rightOffset: 5,
          barSpacing: 6,
          minBarSpacing: 2,
          fixLeftEdge: true,
          fixRightEdge: true,
        },
        crosshair: {
          horzLine: { labelBackgroundColor: '#10b981' },
          vertLine: { labelBackgroundColor: '#10b981' },
        },
      });

      // è½¬æ¢æ—¥æœŸæ ¼å¼ä¸º Lightweight Charts éœ€è¦çš„æ ¼å¼
      const toChartData = (series: Array<{ date: string; value: number }>) =>
        series.map(p => ({ time: p.date, value: p.value }));

      // ç»„åˆå‡€å€¼æ›²çº¿ï¼ˆç»¿è‰²çº¿ï¼Œæ”¯æŒ markersï¼‰
      // å›¾è¡¨æ•°å­—æ ¼å¼åŒ–å‡½æ•°
      const chartFormatter = (p: number) => p.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      const portfolioSeries = chartInstance.addSeries(LineSeries, {
        color: '#10b981',
        lineWidth: 2,
        priceFormat: { type: 'custom', formatter: chartFormatter },
      });
      portfolioSeries.setData(toChartData(valueSeries));

      // QQQ åŸºå‡†æ›²çº¿ï¼ˆè“è‰²è™šçº¿ï¼‰
      if (benchmarkSeries && benchmarkSeries.length > 0) {
        const benchmarkLine = chartInstance.addSeries(LineSeries, {
          color: '#60a5fa',
          lineWidth: 1,
          lineStyle: 2, // è™šçº¿
          priceFormat: { type: 'custom', formatter: chartFormatter },
        });
        benchmarkLine.setData(toChartData(benchmarkSeries));
      }

      // æœ€å¤§å›æ’¤æ ‡æ³¨ï¼ˆä½¿ç”¨ v5 API: createSeriesMarkersï¼‰
      if (maxDrawdownInfo && maxDrawdownInfo.drawdownPct > 0) {
        const peakIdx = valueSeries.findIndex((p: any) => p.date === maxDrawdownInfo.peakDate);
        const troughIdx = valueSeries.findIndex((p: any) => p.date === maxDrawdownInfo.troughDate);

        if (peakIdx >= 0 && troughIdx >= 0) {
          createSeriesMarkers(portfolioSeries, [
            {
              time: maxDrawdownInfo.peakDate,
              position: 'aboveBar',
              color: '#ef4444',
              shape: 'arrowDown',
              text: 'å³°å€¼',
            },
            {
              time: maxDrawdownInfo.troughDate,
              position: 'belowBar',
              color: '#ef4444',
              shape: 'arrowUp',
              text: `-${maxDrawdownInfo.drawdownPct.toFixed(1)}%`,
            },
          ]);
        }

        if (chartInfo) {
          const recoveryText = maxDrawdownInfo.recoveryDate
            ? `æ¢å¤æ—¥æœŸ: <span class="font-mono">${maxDrawdownInfo.recoveryDate}</span>`
            : 'å°šæœªæ¢å¤è‡³å³°å€¼';
          chartInfo.innerHTML = `
            <span class="text-red-500 font-medium">æœ€å¤§å›æ’¤åŒºé—´:</span>
            <span class="font-mono">${maxDrawdownInfo.peakDate}</span> â†’ <span class="font-mono">${maxDrawdownInfo.troughDate}</span>
            <span class="text-onekey-text-muted">(${recoveryText})</span>
          `;
        }
      }

      // è‡ªé€‚åº”æ—¶é—´è½´åˆ°å›æµ‹åŒºé—´
      requestAnimationFrame(() => {
        if (chartInstance) {
          chartInstance.timeScale().fitContent();
        }
      });

      // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ˆå…ˆæ–­å¼€æ—§ observer é˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
      if (chartResizeObserver) {
        chartResizeObserver.disconnect();
        chartResizeObserver = null;
      }
      chartResizeObserver = new ResizeObserver(() => {
        if (chartInstance && chartContainer) {
          chartInstance.resize(chartContainer.clientWidth, 350);
          chartInstance.timeScale().fitContent();
        }
      });
      chartResizeObserver.observe(chartContainer);
    }

    if (addRowBtn) addRowBtn.addEventListener('click', () => rowsEl?.appendChild(createRow('', '1')));
    if (calcBtn) calcBtn.addEventListener('click', calculate);

    addDefaultRows();
    loadWatchlist();
  </script>
</AppLayout>
