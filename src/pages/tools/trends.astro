---
import AppLayout from '@/layouts/AppLayout.astro';
---

<AppLayout title="Trend Radar">
  <div class="space-y-4">
    <!-- 标题区域 -->
    <div class="glass-effect rounded-xl p-6">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h1 class="text-2xl font-bold text-onekey-text-primary">Trend Radar</h1>
        </div>
        <div class="flex items-center gap-2">
          <a href="https://newsbim.pages.dev" target="_blank" rel="noreferrer" class="text-sm px-3 py-2 rounded-lg border border-black/10 bg-white hover:border-onekey-accent-green/30 transition-colors">
            查看数据源
          </a>
          <button id="scanBtn" class="text-sm px-3 py-2 rounded-lg border border-black/10 bg-white hover:border-onekey-accent-green/30" type="button">
            立即扫描
          </button>
        </div>
      </div>
      <div id="metaInfo" class="mt-3 text-xs text-onekey-text-muted font-mono"></div>
    </div>

    <!-- 标签统计柱状图 -->
    <div class="glass-effect rounded-xl p-6">
      <div class="flex items-center justify-between gap-3 mb-4">
        <h2 class="text-lg font-bold text-onekey-text-primary">热门标签</h2>
        <div id="trendControls" class="flex items-center gap-2 text-sm">
          <button class="px-3 py-1 rounded-full border border-black/10 bg-white/60 hover:border-onekey-accent-green/30" data-period="today">今日</button>
          <button class="px-3 py-1 rounded-full border border-black/10 bg-white/60 hover:border-onekey-accent-green/30" data-period="week">本周</button>
        </div>
      </div>
      <div id="chartContainer" class="mt-4">
        <div class="text-sm text-onekey-text-secondary">点击"立即扫描"获取数据...</div>
      </div>
    </div>

    <!-- 标签详情（点击柱状图展开） -->
    <div id="tagDetail" class="glass-effect rounded-xl p-6 hidden">
      <div class="flex items-center justify-between gap-3 mb-4">
        <h2 class="text-lg font-bold text-onekey-text-primary" id="tagDetailTitle">标签详情</h2>
        <button id="closeTagDetail" class="text-sm px-3 py-1 rounded-full border border-black/10 bg-white/60 hover:border-onekey-accent-green/30">关闭</button>
      </div>
      <div id="tagDetailContent" class="space-y-2"></div>
    </div>
  </div>

  <script>
    type TagStats = {
      tag: string;
      count: number;
      trend: 'up' | 'down' | 'stable';
      changePercent: number;
    };

    type NewsItemWithTags = {
      id: string;
      title: string;
      url: string;
      tags: string[];
      tagScore: number;
    };

    type TrendReport = {
      generatedAt: string;
      newsCount: number;
      sources: string[];
      topTags: TagStats[];
      recentNews: NewsItemWithTags[];
    };

    const metaInfoEl = document.getElementById('metaInfo');
    const chartContainerEl = document.getElementById('chartContainer');
    const scanBtn = document.getElementById('scanBtn');
    const tagDetailEl = document.getElementById('tagDetail');
    const tagDetailTitleEl = document.getElementById('tagDetailTitle');
    const tagDetailContentEl = document.getElementById('tagDetailContent');
    const closeTagDetailBtn = document.getElementById('closeTagDetail');

    let currentReport: TrendReport | null = null;

    // 暴露到全局，供标签点击调用
    (window as any).showTagDetail = (tagName: string) => {
      if (currentReport) showTagDetailInternal(tagName);
    };

    function showTagDetailInternal(tagName: string) {
      if (!currentReport || !tagDetailEl || !tagDetailTitleEl || !tagDetailContentEl) return;

      const relatedNews = currentReport.recentNews.filter(item => item.tags.includes(tagName));

      tagDetailTitleEl.textContent = `"${escapeHtml(tagName)}" 相关新闻 (${relatedNews.length})`;

      tagDetailContentEl.innerHTML = relatedNews.length > 0
        ? relatedNews.map(item => `
            <div class="py-2 border-b border-black/5 last:border-0">
              <div class="flex items-start gap-3">
                <div class="flex-1 min-w-0">
                  <a href="${escapeHtml(item.url)}" target="_blank" rel="noreferrer" class="text-sm text-onekey-text-primary hover:underline font-medium line-clamp-2">
                    ${escapeHtml(item.title)}
                  </a>
                  <div class="mt-1 flex items-center gap-2 flex-wrap">
                    ${item.tags.map(t => `<span class="text-xs px-2 py-0.5 rounded-full border ${t === tagName ? 'bg-onekey-accent-green/20 text-green-700 border-onekey-accent-green/40' : 'bg-white/60 text-onekey-text-secondary border-black/10'}">${escapeHtml(t)}</span>`).join('')}
                  </div>
                </div>
              </div>
            </div>
          `).join('')
        : '<div class="text-sm text-onekey-text-secondary">暂无相关新闻</div>';

      tagDetailEl.classList.remove('hidden');
    }

    function escapeHtml(s: string): string {
      return String(s || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // 渲染柱状图
    function renderChart(tags: TagStats[]) {
      if (!chartContainerEl) return;

      // 过滤单字符标签（过于宽泛）并限制显示数量
      const filteredTags = tags
        .filter(t => t.tag.length > 1)
        .slice(0, 20); // 只显示前20个

      const maxCount = Math.max(...filteredTags.map(t => t.count), 1);

      const chartHtml = filteredTags.map(tag => {
        const widthPercent = (tag.count / maxCount) * 100;
        const trendIcon = tag.trend === 'up' ? '↑' : tag.trend === 'down' ? '↓' : '—';
        const trendColor = tag.trend === 'up' ? 'text-green-600' : tag.trend === 'down' ? 'text-red-500' : 'text-gray-400';

        return `
          <div class="chart-row cursor-pointer hover:bg-white/40 rounded-lg p-2 transition-colors" data-tag="${escapeHtml(tag.tag)}">
            <div class="flex items-center justify-between gap-3 mb-1">
              <span class="font-medium text-onekey-text-primary text-sm">${escapeHtml(tag.tag)}</span>
              <div class="flex items-center gap-2">
                <span class="text-xs ${trendColor}">${trendIcon} ${tag.changePercent > 0 ? tag.changePercent.toFixed(1) : 0}%</span>
                <span class="font-mono text-sm text-onekey-text-primary">${tag.count}</span>
              </div>
            </div>
            <div class="h-6 bg-gray-100 rounded-full overflow-hidden">
              <div class="h-full bg-gradient-neon rounded-full transition-all duration-500" style="width: ${widthPercent}%"></div>
            </div>
          </div>
        `;
      }).join('');

      chartContainerEl.innerHTML = filteredTags.length > 0 ? `
        <div class="space-y-3">
          ${chartHtml}
        </div>
      ` : '<div class="text-sm text-onekey-text-secondary">暂无标签数据，点击"立即扫描"获取最新数据</div>';

      // 绑定点击事件显示标签详情
      document.querySelectorAll('.chart-row').forEach(row => {
        row.addEventListener('click', () => {
          const tag = row.getAttribute('data-tag');
          if (tag) showTagDetailInternal(tag);
        });
      });
    }

    // 扫描并加载趋势数据
    async function scanTrends() {
      if (scanBtn) {
        scanBtn.disabled = true;
        scanBtn.textContent = '扫描中...';
      }
      if (chartContainerEl) {
        chartContainerEl.innerHTML = '<div class="text-sm text-onekey-text-secondary">正在从 newsnow 获取新闻并使用 AI 打标签...</div>';
      }

      try {
        const resp = await fetch('/api/trends/scan?ai=true', { credentials: 'include' });
        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
          throw new Error(data?.error || `HTTP ${resp.status}`);
        }

        currentReport = data as TrendReport;

        // 更新元信息
        if (metaInfoEl) {
          const date = new Date(currentReport.generatedAt);
          metaInfoEl.textContent = `更新时间: ${date.toLocaleString('zh-CN')}`;
        }

        // 渲染柱状图
        renderChart(currentReport.topTags);

      } catch (error: any) {
        console.error('Scan error:', error);
        if (chartContainerEl) {
          chartContainerEl.innerHTML = `<div class="text-sm text-red-500">扫描失败: ${escapeHtml(error.message || '未知错误')}</div>`;
        }
      } finally {
        if (scanBtn) {
          scanBtn.disabled = false;
          scanBtn.textContent = '立即扫描';
        }
      }
    }

    // 绑定事件
    if (scanBtn) scanBtn.addEventListener('click', scanTrends);

    if (closeTagDetailBtn) {
      closeTagDetailBtn.addEventListener('click', () => {
        if (tagDetailEl) tagDetailEl.classList.add('hidden');
      });
    }

    // 页面加载时自动扫描
    scanTrends();
  </script>
</AppLayout>
