---
import AppLayout from '@/layouts/AppLayout.astro';
---

<AppLayout title="ç¤¾ä¼šçƒ­ç‚¹æ‰«æ">
  <div class="space-y-4">
    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <div class="glass-effect rounded-xl p-6">
      <h1 class="text-3xl font-bold text-onekey-text-primary text-center">ç¤¾ä¼šçƒ­ç‚¹æ‰«æ</h1>
      <div class="mt-4 flex items-center justify-center gap-3 flex-wrap">
        <div id="metaInfo" class="text-xs text-onekey-text-muted font-mono"></div>
        <div class="flex items-center gap-2">
          <a href="https://newsbim.pages.dev" target="_blank" rel="noreferrer" class="text-xs px-3 py-1.5 rounded-lg border border-black/10 bg-white hover:border-onekey-accent-green/30 transition-colors">
            æŸ¥çœ‹æ•°æ®æº
          </a>
          <button id="scanBtn" class="text-xs px-3 py-1.5 rounded-lg border border-black/10 bg-white hover:border-onekey-accent-green/30" type="button">
            äººå·¥åˆ·æ–°
          </button>
        </div>
      </div>
    </div>

    <!-- è¶‹åŠ¿åˆ†æåŒºåŸŸ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- æœ¬å‘¨é£™å‡æ¦œ -->
      <div class="glass-effect rounded-xl p-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-lg">ğŸ”¥</span>
          <h3 class="font-bold text-onekey-text-primary">æœ¬å‘¨é£™å‡æ¦œ</h3>
        </div>
        <div id="velocityList" class="space-y-2 text-sm">
          <div class="text-onekey-text-secondary">åŠ è½½ä¸­...</div>
        </div>
      </div>

      <!-- æŒç»­çƒ­ç‚¹ -->
      <div class="glass-effect rounded-xl p-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-lg">ğŸ“Š</span>
          <h3 class="font-bold text-onekey-text-primary">æŒç»­çƒ­ç‚¹</h3>
        </div>
        <div id="persistentList" class="space-y-2 text-sm">
          <div class="text-onekey-text-secondary">åŠ è½½ä¸­...</div>
        </div>
      </div>

      <!-- å®æ—¶å¼‚åŠ¨ -->
      <div class="glass-effect rounded-xl p-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-lg">âš¡</span>
          <h3 class="font-bold text-onekey-text-primary">å®æ—¶å¼‚åŠ¨ (24h)</h3>
        </div>
        <div id="recentVelocityList" class="space-y-2 text-sm">
          <div class="text-onekey-text-secondary">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- æ ‡ç­¾ç»Ÿè®¡æŸ±çŠ¶å›¾ -->
    <div class="glass-effect rounded-xl p-6">
      <h2 class="text-lg font-bold text-onekey-text-primary mb-4">çƒ­é—¨æ ‡ç­¾</h2>
      <div id="chartContainer" class="mt-4">
        <div class="text-sm text-onekey-text-secondary">ç‚¹å‡»"äººå·¥åˆ·æ–°"è·å–æ•°æ®...</div>
      </div>
    </div>

    <!-- æ ‡ç­¾è¯¦æƒ…ï¼ˆç‚¹å‡»æŸ±çŠ¶å›¾å±•å¼€ï¼‰ -->
    <div id="tagDetail" class="glass-effect rounded-xl p-6 hidden">
      <div class="flex items-center justify-between gap-3 mb-4">
        <h2 class="text-lg font-bold text-onekey-text-primary" id="tagDetailTitle">æ ‡ç­¾è¯¦æƒ…</h2>
        <button id="closeTagDetail" class="text-sm px-3 py-1 rounded-full border border-black/10 bg-white/60 hover:border-onekey-accent-green/30">å…³é—­</button>
      </div>
      <div id="tagDetailContent" class="space-y-2"></div>
    </div>
  </div>

  <script>
    type TagStats = {
      tag: string;
      count: number;
      trend: 'up' | 'down' | 'stable';
      changePercent: number;
    };

    type NewsItemWithTags = {
      id: string;
      title: string;
      url: string;
      tags: string[];
      tagScore: number;
    };

    type TrendReport = {
      generatedAt: string;
      newsCount: number;
      sources: string[];
      topTags: TagStats[];
      recentNews: NewsItemWithTags[];
      aiQuotaExceeded?: boolean;
      aiApiCalls?: number;
    };

    const metaInfoEl = document.getElementById('metaInfo');
    const chartContainerEl = document.getElementById('chartContainer');
    const scanBtn = document.getElementById('scanBtn');
    const tagDetailEl = document.getElementById('tagDetail');
    const tagDetailTitleEl = document.getElementById('tagDetailTitle');
    const tagDetailContentEl = document.getElementById('tagDetailContent');
    const closeTagDetailBtn = document.getElementById('closeTagDetail');

    let currentReport: TrendReport | null = null;

    // æš´éœ²åˆ°å…¨å±€ï¼Œä¾›æ ‡ç­¾ç‚¹å‡»è°ƒç”¨
    (window as any).showTagDetail = (tagName: string) => {
      if (currentReport) showTagDetailInternal(tagName);
    };

    function showTagDetailInternal(tagName: string) {
      if (!currentReport || !tagDetailEl || !tagDetailTitleEl || !tagDetailContentEl) return;

      const relatedNews = currentReport.recentNews.filter(item => item.tags.includes(tagName));

      tagDetailTitleEl.textContent = `"${escapeHtml(tagName)}" ç›¸å…³æ–°é—» (${relatedNews.length})`;

      tagDetailContentEl.innerHTML = relatedNews.length > 0
        ? relatedNews.map(item => `
            <div class="py-2 border-b border-black/5 last:border-0">
              <div class="flex items-start gap-3">
                <div class="flex-1 min-w-0">
                  <a href="${escapeHtml(item.url)}" target="_blank" rel="noreferrer" class="text-sm text-onekey-text-primary hover:underline font-medium line-clamp-2">
                    ${escapeHtml(item.title)}
                  </a>
                  <div class="mt-1 flex items-center gap-2 flex-wrap">
                    ${item.tags.map(t => `<span class="text-xs px-2 py-0.5 rounded-full border ${t === tagName ? 'bg-onekey-accent-green/20 text-green-700 border-onekey-accent-green/40' : 'bg-white/60 text-onekey-text-secondary border-black/10'}">${escapeHtml(t)}</span>`).join('')}
                  </div>
                </div>
              </div>
            </div>
          `).join('')
        : '<div class="text-sm text-onekey-text-secondary">æš‚æ— ç›¸å…³æ–°é—»</div>';

      tagDetailEl.classList.remove('hidden');
    }

    function escapeHtml(s: string): string {
      return String(s || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // æ¸²æŸ“æŸ±çŠ¶å›¾
    function renderChart(tags: TagStats[]) {
      if (!chartContainerEl) return;

      // è¿‡æ»¤å•å­—ç¬¦æ ‡ç­¾ï¼ˆè¿‡äºå®½æ³›ï¼‰å¹¶é™åˆ¶æ˜¾ç¤ºæ•°é‡
      const filteredTags = tags
        .filter(t => t.tag.length > 1)
        .slice(0, 20); // åªæ˜¾ç¤ºå‰20ä¸ª

      const maxCount = Math.max(...filteredTags.map(t => t.count), 1);

      const chartHtml = filteredTags.map(tag => {
        const widthPercent = (tag.count / maxCount) * 100;
        const trendIcon = tag.trend === 'up' ? 'â†‘' : tag.trend === 'down' ? 'â†“' : 'â€”';
        const trendColor = tag.trend === 'up' ? 'text-green-600' : tag.trend === 'down' ? 'text-red-500' : 'text-gray-400';

        return `
          <div class="chart-row cursor-pointer hover:bg-white/40 rounded-lg p-2 transition-colors" data-tag="${escapeHtml(tag.tag)}">
            <div class="flex items-center justify-between gap-3 mb-1">
              <span class="font-medium text-onekey-text-primary text-sm">${escapeHtml(tag.tag)}</span>
              <div class="flex items-center gap-2">
                <span class="text-xs ${trendColor}">${trendIcon} ${tag.changePercent > 0 ? tag.changePercent.toFixed(1) : 0}%</span>
                <span class="font-mono text-sm text-onekey-text-primary">${tag.count}</span>
              </div>
            </div>
            <div class="h-6 bg-gray-100 rounded-full overflow-hidden">
              <div class="h-full bg-gradient-neon rounded-full transition-all duration-500" style="width: ${widthPercent}%"></div>
            </div>
          </div>
        `;
      }).join('');

      chartContainerEl.innerHTML = filteredTags.length > 0 ? `
        <div class="space-y-3">
          ${chartHtml}
        </div>
      ` : '<div class="text-sm text-onekey-text-secondary">æš‚æ— æ ‡ç­¾æ•°æ®ï¼Œç‚¹å‡»"äººå·¥åˆ·æ–°"è·å–æœ€æ–°æ•°æ®</div>';

      // ç»‘å®šç‚¹å‡»äº‹ä»¶æ˜¾ç¤ºæ ‡ç­¾è¯¦æƒ…
      document.querySelectorAll('.chart-row').forEach(row => {
        row.addEventListener('click', () => {
          const tag = row.getAttribute('data-tag');
          if (tag) showTagDetailInternal(tag);
        });
      });
    }

    // æ‰«æå¹¶åŠ è½½è¶‹åŠ¿æ•°æ®
    async function scanTrends() {
      if (scanBtn) {
        scanBtn.disabled = true;
        scanBtn.textContent = 'åˆ·æ–°ä¸­...';
      }
      if (chartContainerEl) {
        chartContainerEl.innerHTML = '<div class="text-sm text-onekey-text-secondary">æ­£åœ¨ä» newsnow è·å–æ–°é—»å¹¶ä½¿ç”¨ AI æ‰“æ ‡ç­¾...</div>';
      }

      try {
        const resp = await fetch('/api/trends/scan?ai=true', { credentials: 'include' });
        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
          throw new Error(data?.error || `HTTP ${resp.status}`);
        }

        currentReport = data as TrendReport;

        // æ›´æ–°å…ƒä¿¡æ¯
        if (metaInfoEl) {
          const date = new Date(currentReport.generatedAt);
          const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
          let metaText = `æ¯4å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ï¼Œæœ€è¿‘æ›´æ–°æ—¶é—´ä¸º${timeStr}`;
          if (currentReport.aiApiCalls !== undefined) {
            metaText += ` | AI è°ƒç”¨: ${currentReport.aiApiCalls} æ¬¡`;
          }
          metaInfoEl.textContent = metaText;
        }

        // æ¸²æŸ“æŸ±çŠ¶å›¾
        renderChart(currentReport.topTags);

        // é…é¢è¶…é™è­¦å‘Šï¼ˆæ’å…¥åˆ°å›¾è¡¨ä¹‹å‰ï¼‰
        if (currentReport.aiQuotaExceeded && chartContainerEl) {
          const warningHtml = `
            <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-4">
              <div class="flex items-start gap-3">
                <span class="text-yellow-600 text-xl">âš ï¸</span>
                <div>
                  <div class="font-medium text-yellow-800">AI é…é¢å·²è¶…é™</div>
                  <div class="text-sm text-yellow-700 mt-1">
                    æœ¬æ¬¡ä½¿ç”¨äº† ${currentReport.aiApiCalls || 0} æ¬¡ AI è°ƒç”¨ã€‚å·²è‡ªåŠ¨å›é€€åˆ°å…³é”®è¯åŒ¹é…æ¨¡å¼ã€‚
                  </div>
                  <div class="text-sm text-yellow-700 mt-1">
                    å»ºè®®ï¼š1) é™ä½åˆ·æ–°é¢‘ç‡ 2) å‡å°‘æ•°æ®æºæ•°é‡
                  </div>
                </div>
              </div>
            </div>
          `;
          chartContainerEl.insertAdjacentHTML('afterbegin', warningHtml);
        }

      } catch (error: any) {
        console.error('Scan error:', error);
        if (chartContainerEl) {
          chartContainerEl.innerHTML = `<div class="text-sm text-red-500">æ‰«æå¤±è´¥: ${escapeHtml(error.message || 'æœªçŸ¥é”™è¯¯')}</div>`;
        }
      } finally {
        if (scanBtn) {
          scanBtn.disabled = false;
          scanBtn.textContent = 'äººå·¥åˆ·æ–°';
        }
      }
    }

    // ç»‘å®šäº‹ä»¶
    if (scanBtn) scanBtn.addEventListener('click', scanTrends);

    if (closeTagDetailBtn) {
      closeTagDetailBtn.addEventListener('click', () => {
        if (tagDetailEl) tagDetailEl.classList.add('hidden');
      });
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰«æ
    scanTrends();

    // ========== è¶‹åŠ¿åˆ†æåŠŸèƒ½ ==========

    interface VelocityItem {
      tag: string;
      currentCount: number;
      previousCount: number;
      velocity: number;
      percentChange: number;
      trend: 'up' | 'down' | 'stable';
    }

    interface PersistentItem {
      tag: string;
      appearanceCount: number;
      avgCount: number;
      maxCount: number;
      bestRank: number;
    }

    // åŠ è½½æœ¬å‘¨é£™å‡æ¦œ
    async function loadVelocityRanking() {
      const container = document.getElementById('velocityList');
      if (!container) return;

      try {
        const resp = await fetch('/api/trends/history?mode=velocity&days=7&limit=10');
        const data = await resp.json();
        const items = data.items || [];

        if (items.length === 0) {
          container.innerHTML = '<div class="text-onekey-text-secondary">æš‚æ— æ•°æ®</div>';
          return;
        }

        container.innerHTML = items.slice(0, 8).map((item: VelocityItem, i: number) => {
          const trendIcon = item.trend === 'up' ? 'â†‘' : item.trend === 'down' ? 'â†“' : 'â€”';
          const trendColor = item.trend === 'up' ? 'text-green-600' : item.trend === 'down' ? 'text-red-500' : 'text-gray-400';
          const medal = i < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][i] : `<span class="text-gray-400">${i + 1}</span>`;

          return `
            <div class="flex items-center justify-between py-1 cursor-pointer hover:bg-white/40 rounded px-2" onclick="showTagDetail('${escapeHtml(item.tag)}')">
              <div class="flex items-center gap-2">
                <span>${medal}</span>
                <span class="font-medium">${escapeHtml(item.tag)}</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs ${trendColor}">${trendIcon} ${item.percentChange > 0 ? '+' : ''}${item.percentChange}%</span>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Velocity ranking error:', error);
        container.innerHTML = '<div class="text-onekey-text-secondary">åŠ è½½å¤±è´¥</div>';
      }
    }

    // åŠ è½½æŒç»­çƒ­ç‚¹
    async function loadPersistentTags() {
      const container = document.getElementById('persistentList');
      if (!container) return;

      try {
        const resp = await fetch('/api/trends/history?mode=persistent&days=7&limit=10');
        const data = await resp.json();
        const items = data.items || [];

        if (items.length === 0) {
          container.innerHTML = '<div class="text-onekey-text-secondary">æš‚æ— æ•°æ®</div>';
          return;
        }

        container.innerHTML = items.slice(0, 8).map((item: PersistentItem, i: number) => {
          const fireIcon = item.avgCount > 50 ? 'ğŸ”¥' : item.avgCount > 30 ? 'ğŸ“ˆ' : 'ğŸ“Š';

          return `
            <div class="flex items-center justify-between py-1 cursor-pointer hover:bg-white/40 rounded px-2" onclick="showTagDetail('${escapeHtml(item.tag)}')">
              <div class="flex items-center gap-2">
                <span>${fireIcon}</span>
                <span class="font-medium">${escapeHtml(item.tag)}</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500">${item.appearanceCount}æ¬¡</span>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Persistent tags error:', error);
        container.innerHTML = '<div class="text-onekey-text-secondary">åŠ è½½å¤±è´¥</div>';
      }
    }

    // åŠ è½½å®æ—¶å¼‚åŠ¨ (24h)
    async function loadRecentVelocity() {
      const container = document.getElementById('recentVelocityList');
      if (!container) return;

      try {
        const resp = await fetch('/api/trends/history?mode=velocity&hours=24&limit=10');
        const data = await resp.json();
        const items = data.items || [];

        if (items.length === 0) {
          container.innerHTML = '<div class="text-onekey-text-secondary">æš‚æ— æ•°æ®</div>';
          return;
        }

        container.innerHTML = items.slice(0, 8).map((item: VelocityItem) => {
          const trendIcon = item.trend === 'up' ? 'â¬†ï¸' : item.trend === 'down' ? 'â¬‡ï¸' : 'â¡ï¸';
          const bgClass = item.velocity > 10 ? 'bg-green-50 border-green-200' :
                          item.velocity < -10 ? 'bg-red-50 border-red-200' :
                          'bg-gray-50 border-gray-200';

          return `
            <div class="flex items-center justify-between py-1 px-2 rounded border ${bgClass} cursor-pointer hover:opacity-80" onclick="showTagDetail('${escapeHtml(item.tag)}')">
              <div class="flex items-center gap-2">
                <span>${trendIcon}</span>
                <span class="font-medium">${escapeHtml(item.tag)}</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500">${item.currentCount}</span>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Recent velocity error:', error);
        container.innerHTML = '<div class="text-onekey-text-secondary">åŠ è½½å¤±è´¥</div>';
      }
    }

    // é¡µé¢åŠ è½½åè·å–è¶‹åŠ¿åˆ†ææ•°æ®
    setTimeout(() => {
      loadVelocityRanking();
      loadPersistentTags();
      loadRecentVelocity();
    }, 1000);
  </script>
</AppLayout>
